<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSH ERP Settings Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß TSH ERP Settings Test Page</h1>
        <p>This page tests the settings functionality and API connectivity.</p>
        
        <div class="test-section info">
            <h3>üìã Test Results</h3>
            <div id="test-results">Click buttons below to run tests...</div>
        </div>

        <div class="test-section">
            <h3>üîó API Connectivity Tests</h3>
            <button onclick="testSystemInfo()">Test System Info</button>
            <button onclick="testBackupsList()">Test Backups List</button>
            <button onclick="testCreateBackup()">Test Create Backup</button>
            <button onclick="testAllEndpoints()">Test All Endpoints</button>
        </div>

        <div class="test-section">
            <h3>üåê Frontend Tests</h3>
            <button onclick="testFrontendRouting()">Test Frontend Routing</button>
            <button onclick="testCORS()">Test CORS Headers</button>
        </div>

        <div class="test-section">
            <h3>üìä Live System Status</h3>
            <div id="system-status">Loading...</div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/settings';
        const log = (message, type = 'info') => {
            const results = document.getElementById('test-results');
            const timestamp = new Date().toLocaleTimeString();
            results.innerHTML += `<div class="${type}">[${timestamp}] ${message}</div>`;
        };

        async function testSystemInfo() {
            try {
                log('Testing system info endpoint...', 'info');
                const response = await fetch(`${API_BASE}/system/info`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    log(`‚úÖ System Info: SUCCESS - ${data.system_info.database.table_count} tables, ${data.system_info.backups.count} backups`, 'success');
                } else {
                    log('‚ùå System Info: Failed - ' + JSON.stringify(data), 'error');
                }
            } catch (error) {
                log('‚ùå System Info: Error - ' + error.message, 'error');
            }
        }

        async function testBackupsList() {
            try {
                log('Testing backups list endpoint...', 'info');
                const response = await fetch(`${API_BASE}/backups/list`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    log(`‚úÖ Backups List: SUCCESS - Found ${data.total_count} backups`, 'success');
                } else {
                    log('‚ùå Backups List: Failed - ' + JSON.stringify(data), 'error');
                }
            } catch (error) {
                log('‚ùå Backups List: Error - ' + error.message, 'error');
            }
        }

        async function testCreateBackup() {
            try {
                log('Testing backup creation endpoint...', 'info');
                const response = await fetch(`${API_BASE}/backup/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        include_data: true,
                        include_schema: true,
                        description: 'Frontend Test Backup'
                    })
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    log(`‚úÖ Create Backup: SUCCESS - ${data.backup_name} (${data.file_size} bytes)`, 'success');
                } else {
                    log('‚ùå Create Backup: Failed - ' + JSON.stringify(data), 'error');
                }
            } catch (error) {
                log('‚ùå Create Backup: Error - ' + error.message, 'error');
            }
        }

        async function testAllEndpoints() {
            await testSystemInfo();
            await testBackupsList();
            // Skip create backup in bulk test to avoid too many backups
            log('‚úÖ All core endpoints tested', 'info');
        }

        async function testFrontendRouting() {
            try {
                log('Testing frontend routing...', 'info');
                // Test if we can access the settings route
                const currentPath = window.location.pathname;
                log(`üìç Current path: ${currentPath}`, 'info');
                
                if (currentPath.includes('/settings') || window.location.hash.includes('settings')) {
                    log('‚úÖ Frontend Routing: Settings route accessible', 'success');
                } else {
                    log('üîó Frontend Routing: Try navigating to /settings', 'info');
                }
            } catch (error) {
                log('‚ùå Frontend Routing: Error - ' + error.message, 'error');
            }
        }

        async function testCORS() {
            try {
                log('Testing CORS configuration...', 'info');
                const response = await fetch(`${API_BASE}/system/info`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Test-Header': 'test'
                    }
                });
                
                if (response.ok) {
                    log('‚úÖ CORS: Headers accepted, CORS properly configured', 'success');
                } else {
                    log(`‚ùå CORS: Response not OK - ${response.status}`, 'error');
                }
            } catch (error) {
                log('‚ùå CORS: Error - ' + error.message, 'error');
            }
        }

        // Auto-load system status on page load
        window.onload = async function() {
            try {
                const response = await fetch(`${API_BASE}/system/info`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    const info = data.system_info;
                    document.getElementById('system-status').innerHTML = `
                        <div class="success">
                            <h4>‚úÖ System Operational</h4>
                            <p><strong>Database:</strong> ${info.database.table_count} tables, ${info.database.size}</p>
                            <p><strong>Backups:</strong> ${info.backups.count} files, ${Math.round(info.backups.total_size/1024)}KB total</p>
                            <p><strong>Application:</strong> ${info.application.name} v${info.application.version}</p>
                            <p><strong>Last checked:</strong> ${new Date(info.application.last_checked).toLocaleString()}</p>
                        </div>
                    `;
                } else {
                    document.getElementById('system-status').innerHTML = '<div class="error">‚ùå Failed to load system status</div>';
                }
            } catch (error) {
                document.getElementById('system-status').innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        };
    </script>
</body>
</html>
