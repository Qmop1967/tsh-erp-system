# ููุฎุต ูุธุงู ุชุญุฏูุซ ุงูุฑููุฒ ุงูุชููุงุฆู

**Token Refresh Flow - TSH ERP Mobile Apps**

---

## โ ุชู ุงูุชูููุฐ ุจูุฌุงุญ

ุชู ุฅุถุงูุฉ ูุธุงู ุชุญุฏูุซ ุงูุฑููุฒ (Token Refresh) ุงูุชููุงุฆู ูุฌููุน ุชุทุจููุงุช TSH ERP ุงููุญูููุฉ (11 ุชุทุจูู).

---

## ๐ฏ ุงููุฏู

**ุงููุดููุฉ ุงูุณุงุจูุฉ**:
- ุงููุณุชุฎุฏู ูุญุชุงุฌ ูุชุณุฌูู ุงูุฏุฎูู ููููุงู
- ุชูุชูู ุงูุฌูุณุฉ ุจุนุฏ 30 ุฏูููุฉ
- ุชุฌุฑุจุฉ ูุณุชุฎุฏู ุณูุฆุฉ

**ุงูุญู ุงูุฌุฏูุฏ**:
- ุงููุณุชุฎุฏู ูุจูู ูุณุฌู ุฏุฎูู ููุฏุฉ 30 ููู
- ุชุญุฏูุซ ุชููุงุฆู ููุฑูุฒ ูู 30 ุฏูููุฉ
- ุชุฌุฑุจุฉ ุณูุณุฉ ุจุฏูู ุงููุทุงุน

---

## ๐ ุขููุฉ ุงูุนูู

### ููุนุงู ูู ุงูุฑููุฒ (Tokens)

1. **Access Token (ุฑูุฒ ุงููุตูู)**
   - ุงููุฏุฉ: 30 ุฏูููุฉ
   - ุงูุงุณุชุฎุฏุงู: ูุน ูู ุทูุจ API
   - ุงูุฃูุงู: ูุตูุฑ ุงููุฏุฉ ููุญูุงูุฉ

2. **Refresh Token (ุฑูุฒ ุงูุชุญุฏูุซ)**
   - ุงููุฏุฉ: 30 ููู
   - ุงูุงุณุชุฎุฏุงู: ููุญุตูู ุนูู ุฑูุฒ ูุตูู ุฌุฏูุฏ
   - ุงูุฃูุงู: ุทููู ุงููุฏุฉ ูุฑุงุญุฉ ุงููุณุชุฎุฏู

### ุงูุณููุงุฑูู

```
1. ุงููุณุชุฎุฏู ูุณุฌู ุฏุฎูู ูุฑุฉ ูุงุญุฏุฉ
   โ
2. ูุญุตู ุนูู ุฑูุฒูู (Access + Refresh)
   โ
3. ุงูุชุทุจูู ูุญูุธ ุงูุฑูุฒูู ุจุดูู ุขูู
   โ
4. ุฃูู 30 ุฏูููุฉ: ูุณุชุฎุฏู Access Token
   โ
5. ุจุนุฏ 30 ุฏูููุฉ: Access Token ููุชูู
   โ
6. ุงูุชุทุจูู ุชููุงุฆูุงู ูุทูุจ ุฑูุฒ ุฌุฏูุฏ
   (ุจุงุณุชุฎุฏุงู Refresh Token)
   โ
7. ูุญุตู ุนูู Access Token ุฌุฏูุฏ
   โ
8. ูุณุชูุฑ ุงูุนูู ุจุฏูู ุงููุทุงุน
   โ
9. ูุชูุฑุฑ ูุฐุง ููุฏุฉ 30 ููู
   โ
10. ุจุนุฏ 30 ููู: Refresh Token ููุชูู
    โ ุงููุณุชุฎุฏู ูุญุชุงุฌ ุชุณุฌูู ุฏุฎูู ุฌุฏูุฏ
```

---

## ๐๏ธ ูุง ุชู ุชุทููุฑู

### 1. Backend (FastAPI)

โ **ููู**: `/app/services/auth_service.py`
- ุฅุถุงูุฉ ุฏุงูุฉ `create_refresh_token()`
- ุชุญุฏูุซ `verify_token()` ููุชุญูู ูู ููุน ุงูุฑูุฒ
- ุฅุถุงูุฉ ูุชุบูุฑ `REFRESH_TOKEN_EXPIRE_DAYS = 30`

โ **ููู**: `/app/routers/auth.py`
- ุชุญุฏูุซ `/auth/login/mobile` ูุฅุฑุฌุงุน refresh_token
- ุฅุถุงูุฉ endpoint ุฌุฏูุฏ: `/auth/refresh`
- ุงูุชุญูู ูู ุตูุงุญูุฉ ุงูุฑููุฒ

โ **ููู**: `/app/schemas/auth.py`
- ุฅุถุงูุฉ `refresh_token` ูู `LoginResponse`
- ุฅุถุงูุฉ `RefreshTokenRequest` schema
- ุฅุถุงูุฉ `RefreshTokenResponse` schema

### 2. Flutter (Mobile Apps)

โ **ููู**: `shared/tsh_core_package/lib/src/services/api_service.dart`
- ุชุญุฏูุซ `_refreshToken()` ููุชูุงูู ูุน Backend ุงูุฌุฏูุฏ
- ุฅุถุงูุฉ Interceptor ููุชุญุฏูุซ ุงูุชููุงุฆู ุนูุฏ 401
- ุญูุธ ูุงุณุชุฑุฌุงุน ุงูุฑููุฒ ูู Secure Storage

โ **ููู**: `shared/tsh_core_package/lib/src/services/auth_service.dart`
- ุชุญุฏูุซ `login()` ูุญูุธ refresh_token
- ุงุณุชุฎุฏุงู endpoint `/auth/login/mobile`
- ูุนุงูุฌุฉ response ุงูุฌุฏูุฏ

---

## ๐ฑ ุงูุชุทุจููุงุช ุงููุดูููุฉ

ุฌููุน ุชุทุจููุงุช TSH ERP (11 ุชุทุจูู):
1. โ TSH Admin App
2. โ TSH Admin Security
3. โ TSH Accounting App
4. โ TSH HR App
5. โ TSH Inventory App
6. โ TSH Salesperson App
7. โ TSH Retail Sales App (POS)
8. โ TSH Partner Network App
9. โ TSH Wholesale Client App
10. โ TSH Consumer App
11. โ TSH After-Sales Operations (ASO)

**ููุงุญุธุฉ**: ุฌููุน ุงูุชุทุจููุงุช ุชุณุชุฎุฏู `tsh_core_package` ุงููุดุชุฑูุ ูุฐูู ุงูุชุญุฏูุซ ุชููุงุฆู ูุฌููุน ุงูุชุทุจููุงุช.

---

## ๐ ุงูุฃูุงู

### ุชุฎุฒูู ุขูู
- ุงุณุชุฎุฏุงู `flutter_secure_storage`
- ุชุดููุฑ ุงูุฑููุฒ
- iOS: ูุณุชุฎุฏู Keychain
- Android: ูุณุชุฎุฏู KeyStore

### ุญูุงูุฉ ูู ุณูุก ุงูุงุณุชุฎุฏุงู
- ูู ุฑูุฒ ูู ููุน (type field)
- ุงูุชุญูู ูู ุงูููุน ูุจู ุงูุงุณุชุฎุฏุงู
- ูุง ูููู ุงุณุชุฎุฏุงู refresh token ูู access token

### ุงูุชูุงุก ุงูุตูุงุญูุฉ
- Access Token: 30 ุฏูููุฉ (ูุตูุฑ ููุฃูุงู)
- Refresh Token: 30 ููู (ุทููู ููุฑุงุญุฉ)

---

## ๐ค ุชุฌุฑุจุฉ ุงููุณุชุฎุฏู

### ูุงุฐุง ูุฑู ุงููุณุชุฎุฏูุ

1. **ุชุณุฌูู ุฏุฎูู ูุงุญุฏ**: ูุฏุฎู email ู password ูุฑุฉ ูุงุญุฏุฉ
2. **ุนูู ูุณุชูุฑ**: ูุณุชุฎุฏู ุงูุชุทุจูู ุจุฏูู ุงููุทุงุน
3. **ูุง ุชูุฌุฏ ุฑุณุงุฆู "ุงูุชูุช ุงูุฌูุณุฉ"**: ุงูุชุญุฏูุซ ูุชู ุชููุงุฆูุงู
4. **30 ููู ูุงููุฉ**: ูุจูู ูุณุฌู ุฏุฎูู
5. **ุจุนุฏ 30 ููู**: ูุญุชุงุฌ ุชุณุฌูู ุฏุฎูู ุฌุฏูุฏ

### ุดูุงููุฉ ูุงููุฉ

ุงููุณุชุฎุฏู ูุง ูุดุนุฑ ุจุฃู ุดูุก:
- โ ูุง ุชูุฌุฏ ุฑุณุงุฆู ุฎุทุฃ
- โ ูุง ููุฌุฏ ุงููุทุงุน ูู ุงูุนูู
- โ ูุง ุชูุฌุฏ ุดุงุดุงุช ุชุญููู ุฅุถุงููุฉ
- โ ุนูู ุณูุณ ููุณุชูุฑ

---

## ๐งช ุงูุงุฎุชุจุงุฑ

### ุงุฎุชุจุงุฑ ูุฏูู (Manual Testing)

#### 1. ุชุณุฌูู ุงูุฏุฎูู
```bash
curl -X POST http://192.168.68.51:8000/api/auth/login/mobile \
  -H "Content-Type: application/json" \
  -d '{"email": "admin@tsh.com", "password": "admin123"}'
```

**ุงููุชูุฌุฉ ุงููุชููุนุฉ**:
```json
{
  "access_token": "eyJ...",
  "refresh_token": "eyJ...",
  "token_type": "bearer",
  "user": {...}
}
```

#### 2. ุชุญุฏูุซ ุงูุฑูุฒ
```bash
curl -X POST http://192.168.68.51:8000/api/auth/refresh \
  -H "Content-Type: application/json" \
  -d '{"refresh_token": "eyJ..."}'
```

**ุงููุชูุฌุฉ ุงููุชููุนุฉ**:
```json
{
  "access_token": "eyJ... (ุฑูุฒ ุฌุฏูุฏ)",
  "token_type": "bearer"
}
```

### ูุงุฆูุฉ ูุญุต ุงูุชุทุจูู

- [ ] ุงููุณุชุฎุฏู ูุณุชุทูุน ุชุณุฌูู ุงูุฏุฎูู
- [ ] ูุชู ุญูุธ access_token ูู Secure Storage
- [ ] ูุชู ุญูุธ refresh_token ูู Secure Storage
- [ ] ุทูุจุงุช API ุชุนูู ูุน ุงูุฑูุฒ ุงูุตุงูุญ
- [ ] ุจุนุฏ 30 ุฏูููุฉุ ูุญุฏุซ ุงูุชุญุฏูุซ ุชููุงุฆูุงู
- [ ] ุงููุณุชุฎุฏู ูุง ูุดุนุฑ ุจุฃู ุงููุทุงุน
- [ ] ุจุนุฏ 30 ูููุ ูุชู ุชุณุฌูู ุฎุฑูุฌ ุงููุณุชุฎุฏู
- [ ] ุงูุฑููุฒ ุบูุฑ ุงูุตุงูุญุฉ ูุชู ุญุฐููุง
- [ ] ุฃุฎุทุงุก ุงูุดุจูุฉ ุชูุนุงูุฌ ุจุดูู ุตุญูุญ

---

## ๐ ุงูุฅุนุฏุงุฏุงุช

### Backend (.env)

```bash
ACCESS_TOKEN_EXPIRE_MINUTES=30
REFRESH_TOKEN_EXPIRE_DAYS=30
SECRET_KEY=your-secret-key
ALGORITHM=HS256
```

**ุงูููู**: `/Users/khaleelal-mulla/TSH_ERP_Ecosystem/.env`

### Flutter

ูุง ุชูุฌุฏ ุฅุนุฏุงุฏุงุช ุฅุถุงููุฉ - ูู ุดูุก ูู `tsh_core_package`

---

## ๐ ุงููุซุงุฆู ุงููุงููุฉ

ููุชูุงุตูู ุงูุชูููุฉ ุงููุงููุฉุ ุฑุงุฌุน:
- `TOKEN_REFRESH_FLOW.md` - ูุซุงุฆู ูุงููุฉ ุจุงูุฅูุฌููุฒูุฉ
- ูุดูู: ุฃูุซูุฉ ููุฏุ ุฑุณูู ุชูุถูุญูุฉุ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

---

## โจ ุงูููุงุฆุฏ

### ูููุณุชุฎุฏููู
- โ ูุง ุญุงุฌุฉ ูุชุณุฌูู ุฏุฎูู ูููู
- โ ุนูู ูุณุชูุฑ ุจุฏูู ุงููุทุงุน
- โ ุชุฌุฑุจุฉ ุงุญุชุฑุงููุฉ
- โ ุฑุงุญุฉ ุฃูุซุฑ

### ููุฃุนูุงู
- โ ุฑุถุง ุฃุนูู ูููุณุชุฎุฏููู
- โ ุงุณุชุฎุฏุงู ุฃูุซุฑ ููุชุทุจููุงุช
- โ ุฃูู ุทูุจุงุช ุฏุนู
- โ ุตูุฑุฉ ุงุญุชุฑุงููุฉ

### ูููุทูุฑูู
- โ ููุฏ ูุฑูุฒู (shared package)
- โ ุชุญุฏูุซ ุชููุงุฆู (ูุง ุญุงุฌุฉ ูุฃููุงุฏ ูุฏููุฉ)
- โ ุณูููุฉ ุงูุตูุงูุฉ
- โ ูุนุงููุฑ ุตูุงุนูุฉ

---

## ๐ ุงูุญุงูุฉ

**โ ุชู ุงูุชูููุฐ ุจุงููุงูู**

**ุฌุงูุฒ ููุงุณุชุฎุฏุงู ุงูููุฑู**

**ูุดูู ุฌููุน 11 ุชุทุจูู**

---

## ๐ ุฅุฐุง ูุงู ููุงู ูุดุงูู

### ุงููุณุชุฎุฏู ูุฎุฑุฌ ูู ุงูุชุทุจูู ุจุงุณุชูุฑุงุฑ

**ุงูุฃุณุจุงุจ ุงููุญุชููุฉ**:
- ุงูุชูู refresh token (ุจุนุฏ 30 ููู)
- ุชุบููุฑ SECRET_KEY ูู Backend
- ุญูุฐูุช ุงูุฑููุฒ ูู ุงูุชุฎุฒูู

**ุงูุญู**: ุชุณุฌูู ุฏุฎูู ุฌุฏูุฏ

### ุฑุณุงูุฉ "Invalid refresh token"

**ุงูุฃุณุจุงุจ ุงููุญุชููุฉ**:
- refresh token ุบูุฑ ุตุญูุญ
- ูุดููุฉ ูู SECRET_KEY
- ููุน ุงูุฑูุฒ ุฎุงุทุฆ

**ุงูุญู**: ุญุฐู ุงูุฑููุฒ ูุชุณุฌูู ุฏุฎูู ุฌุฏูุฏ

---

## ๐ ุงูุฎูุงุตุฉ

ุชู ุจูุฌุงุญ ุฅุถุงูุฉ ูุธุงู Token Refresh ููุญูุงุธ ุนูู ุชุณุฌูู ุฏุฎูู ุงููุณุชุฎุฏููู ููุฏุฉ 30 ููู ุจุฏูุงู ูู ุชุณุฌูู ุฏุฎูู ูููู.

### ุงูุชุบููุฑุงุช ุงูุฑุฆูุณูุฉ:

1. โ Backend ูุตุฏุฑ ุฑูุฒูู (access + refresh)
2. โ Flutter ูุญูุธ ุงูุฑูุฒูู ุจุดูู ุขูู
3. โ ุชุญุฏูุซ ุชููุงุฆู ุนูุฏ ุงูุชูุงุก access token
4. โ ุงููุณุชุฎุฏู ูุง ูุดุนุฑ ุจุฃู ุงููุทุงุน
5. โ ูุนูู ุนูู ุฌููุน 11 ุชุทุจูู

### ุงููููุงุช ุงููุนุฏูุฉ:

**Backend:**
- `app/services/auth_service.py`
- `app/routers/auth.py`
- `app/schemas/auth.py`

**Flutter:**
- `shared/tsh_core_package/lib/src/services/api_service.dart`
- `shared/tsh_core_package/lib/src/services/auth_service.dart`

---

**ุชุงุฑูุฎ ุงูุชุญุฏูุซ**: 2025-01-24

**ุงูุญุงูุฉ**: โ ููุฌุฒ ููุฎุชุจุฑ

**ุฌุงูุฒ ููุฅูุชุงุฌ**: ูุนู
