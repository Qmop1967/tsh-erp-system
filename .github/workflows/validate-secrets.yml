name: Validate Required Secrets

on:
  workflow_call:
    inputs:
      environment:
        description: 'Environment to validate (production, staging, development)'
        required: true
        type: string
      check_scope:
        description: 'Scope of validation (deployment, ci, all)'
        required: false
        type: string
        default: 'all'
    outputs:
      validation_passed:
        description: 'Whether all required secrets are present'
        value: ${{ jobs.validate.outputs.validation_passed }}
      missing_secrets:
        description: 'List of missing secrets'
        value: ${{ jobs.validate.outputs.missing_secrets }}

  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to validate'
        required: true
        type: choice
        options:
          - production
          - staging
          - development
      check_scope:
        description: 'Scope of validation'
        required: false
        type: choice
        options:
          - all
          - deployment
          - ci
          - notifications
          - integrations
        default: 'all'

  schedule:
    # Run every Monday at 8 AM UTC
    - cron: '0 8 * * 1'

jobs:
  validate:
    name: Validate Secrets - ${{ inputs.environment || 'production' }}
    runs-on: ubuntu-latest
    timeout-minutes: 5

    outputs:
      validation_passed: ${{ steps.validate.outputs.validation_passed }}
      missing_secrets: ${{ steps.validate.outputs.missing_secrets }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set environment
        id: set-env
        run: |
          ENV="${{ inputs.environment || 'production' }}"
          SCOPE="${{ inputs.check_scope || 'all' }}"
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "scope=$SCOPE" >> $GITHUB_OUTPUT

      - name: Validate secrets
        id: validate
        env:
          # SSH Secrets
          PROD_HOST: ${{ secrets.PROD_HOST }}
          PROD_USER: ${{ secrets.PROD_USER }}
          PROD_SSH_KEY: ${{ secrets.PROD_SSH_KEY }}
          STAGING_HOST: ${{ secrets.STAGING_HOST }}
          STAGING_USER: ${{ secrets.STAGING_USER }}
          STAGING_SSH_KEY: ${{ secrets.STAGING_SSH_KEY }}

          # Database Secrets
          PROD_DB_HOST: ${{ secrets.PROD_DB_HOST }}
          PROD_DB_PORT: ${{ secrets.PROD_DB_PORT }}
          PROD_DB_NAME: ${{ secrets.PROD_DB_NAME }}
          PROD_DB_USER: ${{ secrets.PROD_DB_USER }}
          PROD_DB_PASSWORD: ${{ secrets.PROD_DB_PASSWORD }}
          STAGING_DB_HOST: ${{ secrets.STAGING_DB_HOST }}
          STAGING_DB_PORT: ${{ secrets.STAGING_DB_PORT }}
          STAGING_DB_NAME: ${{ secrets.STAGING_DB_NAME }}
          STAGING_DB_USER: ${{ secrets.STAGING_DB_USER }}
          STAGING_DB_PASSWORD: ${{ secrets.STAGING_DB_PASSWORD }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          REDIS_URL: ${{ secrets.REDIS_URL }}

          # Security Secrets
          JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}

          # Notification Secrets
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          EMAIL_HOST: ${{ secrets.EMAIL_HOST }}
          EMAIL_PORT: ${{ secrets.EMAIL_PORT }}
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}

          # Zoho Integration
          ZOHO_CLIENT_ID: ${{ secrets.ZOHO_CLIENT_ID }}
          ZOHO_CLIENT_SECRET: ${{ secrets.ZOHO_CLIENT_SECRET }}
          ZOHO_REFRESH_TOKEN: ${{ secrets.ZOHO_REFRESH_TOKEN }}
          ZOHO_ORGANIZATION_ID: ${{ secrets.ZOHO_ORGANIZATION_ID }}

          # AWS S3
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
          AWS_REGION: ${{ secrets.AWS_REGION }}

          # Code Coverage
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
        run: |
          python3 << 'EOF'
          import os
          import json
          import sys

          ENV = os.getenv('GITHUB_OUTPUT')
          ENVIRONMENT = "${{ steps.set-env.outputs.environment }}"
          SCOPE = "${{ steps.set-env.outputs.scope }}"

          # Define required secrets by scope and environment
          REQUIRED_SECRETS = {
              "deployment": {
                  "production": [
                      "PROD_HOST",
                      "PROD_USER",
                      "PROD_SSH_KEY",
                      "PROD_DB_HOST",
                      "PROD_DB_NAME",
                      "PROD_DB_USER",
                      "PROD_DB_PASSWORD",
                  ],
                  "staging": [
                      "STAGING_HOST",
                      "STAGING_USER",
                      "STAGING_SSH_KEY",
                      "STAGING_DB_HOST",
                      "STAGING_DB_NAME",
                      "STAGING_DB_USER",
                      "STAGING_DB_PASSWORD",
                  ],
                  "development": [],
              },
              "ci": {
                  "all": [
                      "DATABASE_URL",
                      "REDIS_URL",
                      "JWT_SECRET_KEY",
                      "SECRET_KEY",
                  ]
              },
              "notifications": {
                  "all": [
                      "TELEGRAM_BOT_TOKEN",
                      "TELEGRAM_CHAT_ID",
                  ]
              },
              "integrations": {
                  "all": [
                      "ZOHO_CLIENT_ID",
                      "ZOHO_CLIENT_SECRET",
                      "ZOHO_REFRESH_TOKEN",
                      "ZOHO_ORGANIZATION_ID",
                  ]
              }
          }

          # Optional secrets (warnings only)
          OPTIONAL_SECRETS = {
              "notifications": [
                  "EMAIL_HOST",
                  "EMAIL_PORT",
                  "EMAIL_USER",
                  "EMAIL_PASSWORD",
                  "EMAIL_FROM",
              ],
              "integrations": [
                  "AWS_ACCESS_KEY_ID",
                  "AWS_SECRET_ACCESS_KEY",
                  "AWS_S3_BUCKET",
                  "AWS_REGION",
                  "CODECOV_TOKEN",
              ]
          }

          # Determine which secrets to check
          secrets_to_check = []

          if SCOPE == "all":
              # Check all required secrets for the environment
              for scope_type, envs in REQUIRED_SECRETS.items():
                  if ENVIRONMENT in envs:
                      secrets_to_check.extend(envs[ENVIRONMENT])
                  elif "all" in envs:
                      secrets_to_check.extend(envs["all"])
          else:
              # Check specific scope
              if SCOPE in REQUIRED_SECRETS:
                  if ENVIRONMENT in REQUIRED_SECRETS[SCOPE]:
                      secrets_to_check.extend(REQUIRED_SECRETS[SCOPE][ENVIRONMENT])
                  elif "all" in REQUIRED_SECRETS[SCOPE]:
                      secrets_to_check.extend(REQUIRED_SECRETS[SCOPE]["all"])

          # Remove duplicates
          secrets_to_check = list(set(secrets_to_check))

          # Validate secrets
          missing_required = []
          missing_optional = []
          present_secrets = []

          print(f"\n{'=' * 70}")
          print(f"üîê SECRET VALIDATION - {ENVIRONMENT.upper()}")
          print(f"Scope: {SCOPE}")
          print(f"{'=' * 70}\n")

          # Check required secrets
          print("üìã Checking Required Secrets:")
          print("-" * 70)
          for secret in sorted(secrets_to_check):
              value = os.getenv(secret)
              if value:
                  present_secrets.append(secret)
                  # Mask the value for security
                  masked_value = f"{value[:4]}...{value[-4:]}" if len(value) > 8 else "****"
                  print(f"  ‚úÖ {secret:<40} {masked_value}")
              else:
                  missing_required.append(secret)
                  print(f"  ‚ùå {secret:<40} NOT SET")

          # Check optional secrets
          print("\nüìã Checking Optional Secrets:")
          print("-" * 70)
          optional_to_check = []
          if SCOPE == "all" or SCOPE in OPTIONAL_SECRETS:
              optional_to_check = OPTIONAL_SECRETS.get(SCOPE, [])
              if SCOPE == "all":
                  for secrets_list in OPTIONAL_SECRETS.values():
                      optional_to_check.extend(secrets_list)
              optional_to_check = list(set(optional_to_check))

          for secret in sorted(optional_to_check):
              value = os.getenv(secret)
              if value:
                  present_secrets.append(secret)
                  masked_value = f"{value[:4]}...{value[-4:]}" if len(value) > 8 else "****"
                  print(f"  ‚úÖ {secret:<40} {masked_value}")
              else:
                  missing_optional.append(secret)
                  print(f"  ‚ö†Ô∏è  {secret:<40} NOT SET (optional)")

          # Summary
          print(f"\n{'=' * 70}")
          print("üìä VALIDATION SUMMARY")
          print(f"{'=' * 70}")
          print(f"\nTotal Secrets Checked: {len(secrets_to_check) + len(optional_to_check)}")
          print(f"  ‚úÖ Present:          {len(present_secrets)}")
          print(f"  ‚ùå Missing Required: {len(missing_required)}")
          print(f"  ‚ö†Ô∏è  Missing Optional: {len(missing_optional)}")

          if missing_required:
              print(f"\n{'‚îÄ' * 70}")
              print("‚ùå MISSING REQUIRED SECRETS:")
              print(f"{'‚îÄ' * 70}")
              for secret in missing_required:
                  print(f"  ‚Ä¢ {secret}")
              print(f"\n‚ö†Ô∏è  Add these secrets in GitHub Settings:")
              print(f"   Repository ‚Üí Settings ‚Üí Secrets and variables ‚Üí Actions")

          if missing_optional:
              print(f"\n{'‚îÄ' * 70}")
              print("‚ö†Ô∏è  MISSING OPTIONAL SECRETS:")
              print(f"{'‚îÄ' * 70}")
              for secret in missing_optional:
                  print(f"  ‚Ä¢ {secret}")
              print(f"\n‚ÑπÔ∏è  These secrets are optional but recommended for full functionality")

          print(f"\n{'=' * 70}")

          # Set outputs
          validation_passed = len(missing_required) == 0

          with open(ENV, 'a') as f:
              f.write(f"validation_passed={'true' if validation_passed else 'false'}\n")
              f.write(f"missing_secrets={','.join(missing_required)}\n")
              f.write(f"missing_count={len(missing_required)}\n")
              f.write(f"optional_missing_count={len(missing_optional)}\n")

          # Write detailed report
          report = {
              "environment": ENVIRONMENT,
              "scope": SCOPE,
              "validation_passed": validation_passed,
              "summary": {
                  "total_checked": len(secrets_to_check) + len(optional_to_check),
                  "present": len(present_secrets),
                  "missing_required": len(missing_required),
                  "missing_optional": len(missing_optional),
              },
              "missing_required": missing_required,
              "missing_optional": missing_optional,
              "present_secrets": present_secrets,
          }

          with open('secret-validation-report.json', 'w') as f:
              json.dump(report, f, indent=2)

          if validation_passed:
              print("‚úÖ ALL REQUIRED SECRETS ARE PRESENT")
          else:
              print("‚ùå VALIDATION FAILED - MISSING REQUIRED SECRETS")

          print(f"{'=' * 70}\n")

          # Exit with error if validation failed
          sys.exit(0 if validation_passed else 1)
          EOF

      - name: Upload validation report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: secret-validation-report-${{ steps.set-env.outputs.environment }}
          path: secret-validation-report.json
          retention-days: 30

      - name: Send notification on failure
        if: failure() && (secrets.TELEGRAM_BOT_TOKEN != '' && secrets.TELEGRAM_CHAT_ID != '')
        run: |
          ENVIRONMENT="${{ steps.set-env.outputs.environment }}"
          MISSING_COUNT="${{ steps.validate.outputs.missing_count || 0 }}"
          MISSING_SECRETS="${{ steps.validate.outputs.missing_secrets }}"

          MESSAGE="‚ö†Ô∏è *Secret Validation Failed*

          üåç *Environment:* \`${ENVIRONMENT}\`
          üîê *Missing Secrets:* ${MISSING_COUNT}

          *Secrets Not Found:*
          $(echo "$MISSING_SECRETS" | tr ',' '\n' | sed 's/^/‚Ä¢ /')

          ‚ö†Ô∏è *Action Required:*
          Add missing secrets in GitHub repository settings

          üîó Settings: ${{ github.server_url }}/${{ github.repository }}/settings/secrets/actions

          üìñ Guide: [GitHub Secrets Setup](https://github.com/${{ github.repository }}/blob/main/docs/ci-cd/github-secrets-setup.md)"

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="$MESSAGE" \
            -d parse_mode="Markdown" \
            -d disable_web_page_preview=true

      - name: Create GitHub issue on failure
        if: failure() && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const missingSecrets = '${{ steps.validate.outputs.missing_secrets }}'.split(',').filter(Boolean);
            const environment = '${{ steps.set-env.outputs.environment }}';

            const body = `## Secret Validation Failed

            **Environment:** \`${environment}\`
            **Missing Secrets:** ${missingSecrets.length}

            ### Missing Required Secrets

            ${missingSecrets.map(s => `- [ ] \`${s}\``).join('\n')}

            ### Action Required

            Add these secrets in [GitHub repository settings](${{ github.server_url }}/${{ github.repository }}/settings/secrets/actions).

            Refer to the [GitHub Secrets Setup Guide](https://github.com/${{ github.repository }}/blob/main/docs/ci-cd/github-secrets-setup.md) for detailed instructions.

            ### Validation Report

            [Download full report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ---
            *This issue was automatically created by the secret validation workflow.*
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üîê Missing Required Secrets - ${environment}`,
              body: body,
              labels: ['security', 'ci-cd', 'configuration']
            });

      - name: Fail on missing secrets
        if: steps.validate.outputs.validation_passed == 'false'
        run: |
          echo "‚ùå Secret validation failed"
          echo "Missing required secrets: ${{ steps.validate.outputs.missing_secrets }}"
          exit 1
