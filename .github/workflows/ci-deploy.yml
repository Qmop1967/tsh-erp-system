name: CI/CD - Test and Deploy to Production

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  PYTHON_VERSION: "3.11"

jobs:
  test:
    name: Run Tests and Security Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio ruff mypy bandit

      - name: Code linting (ruff)
        run: |
          ruff check . --output-format=github
        continue-on-error: true

      - name: Type checking (mypy)
        run: |
          mypy . --ignore-missing-imports --no-strict-optional
        continue-on-error: true

      - name: Security scan (bandit)
        run: |
          bandit -r . -f json -o bandit-report.json || true
          bandit -r . -f screen
        continue-on-error: true

      - name: Run unit tests
        run: |
          pytest tests/ -v --cov=. --cov-report=term --cov-report=xml || true
        continue-on-error: true

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
        continue-on-error: true

  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    needs: test
    # Only deploy if on main branch
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Check SSH secrets
        id: check_secrets
        run: |
          if [ -z "${{ secrets.PROD_HOST }}" ] || [ -z "${{ secrets.PROD_USER }}" ] || [ -z "${{ secrets.PROD_SSH_KEY }}" ]; then
            echo "⚠️ SSH secrets not configured. Skipping deployment."
            echo "To enable automatic deployment, configure these secrets in GitHub:"
            echo "  - PROD_HOST"
            echo "  - PROD_USER"
            echo "  - PROD_SSH_KEY"
            echo "For manual deployment, run: ssh root@erp.tsh.sale 'bash -s' < deployment/deploy_phase1.sh"
            echo "skip=true" >> "$GITHUB_OUTPUT"
          else
            echo "✅ SSH secrets detected"
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Deploy via SSH
        if: steps.check_secrets.outputs.skip != 'true'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: ${{ secrets.PROD_SSH_PORT || 22 }}
          script_stop: true
          script: |
            set -eo pipefail

            echo "========================================"
            echo "Starting TSH ERP Backend Deployment..."
            echo "========================================"

            if [ -d "/home/deploy/TSH_ERP_Ecosystem" ]; then
              DEPLOY_DIR="/home/deploy/TSH_ERP_Ecosystem"
            elif [ -d "/opt/tsh_erp" ]; then
              DEPLOY_DIR="/opt/tsh_erp"
            else
              echo "❌ Deployment directory not found (/home/deploy/TSH_ERP_Ecosystem or /opt/tsh_erp)"
              exit 1
            fi

            echo "[1/6] Navigating to application directory..."
            cd "${DEPLOY_DIR}"

            if [ ! -d ".git" ]; then
              echo "❌ Error: Not a git repository"
              exit 1
            fi

            echo "[2/6] Pulling latest code..."
            git fetch origin
            git reset --hard origin/main

            echo "[3/6] Preparing environment..."
            if [ -f "./deploy.sh" ]; then
              chmod +x ./deploy.sh
            fi

            if [ -d "venv" ] || [ -d ".venv" ]; then
              VENV_PATH="venv"
              [ -d ".venv" ] && VENV_PATH=".venv"
              echo "Activating virtual environment: ${VENV_PATH}"
              # shellcheck disable=SC1090
              source "${VENV_PATH}/bin/activate"
              pip install -q --upgrade pip
              pip install -q -r requirements.txt || true
            elif command -v pip3 >/dev/null 2>&1 && [ -f "requirements.txt" ]; then
              pip3 install -q --upgrade pip
              pip3 install -q -r requirements.txt || true
            fi

            echo "[4/6] Applying deployment strategy..."
            DEPLOYMENT_METHOD="none"
            RESTART_SUCCESS=0

            if systemctl list-unit-files | grep -q '^tsh-erp\.service'; then
              echo "Using systemd service tsh-erp.service"
              if systemctl restart tsh-erp; then
                RESTART_SUCCESS=1
                DEPLOYMENT_METHOD="systemd (tsh-erp.service)"
              else
                echo "⚠️ systemctl restart tsh-erp failed"
              fi
            fi

            if [ ${RESTART_SUCCESS} -eq 0 ] && systemctl list-unit-files | grep -q '^tsh_erp\.service'; then
              echo "Using systemd service tsh_erp.service"
              if systemctl restart tsh_erp; then
                RESTART_SUCCESS=1
                DEPLOYMENT_METHOD="systemd (tsh_erp.service)"
              else
                echo "⚠️ systemctl restart tsh_erp failed"
              fi
            fi

            if [ ${RESTART_SUCCESS} -eq 0 ] && [ -f "docker-compose.yml" ] && command -v docker >/dev/null 2>&1; then
              if docker compose version >/dev/null 2>&1; then
                echo "Using docker compose with core profile"
                docker compose --profile core down --remove-orphans || true
                docker compose --profile core pull || true
                docker compose --profile core up -d --build
                RESTART_SUCCESS=1
                DEPLOYMENT_METHOD="docker compose (profile: core)"
              elif command -v docker-compose >/dev/null 2>&1; then
                echo "Using docker-compose with core profile"
                docker-compose --profile core down --remove-orphans || true
                docker-compose --profile core pull || true
                docker-compose --profile core up -d --build
                RESTART_SUCCESS=1
                DEPLOYMENT_METHOD="docker-compose (profile: core)"
              fi
            fi

            if [ ${RESTART_SUCCESS} -eq 0 ] && [ -f "./deploy.sh" ]; then
              echo "Falling back to ./deploy.sh update"
              ./deploy.sh update || ./deploy.sh restart || ./deploy.sh start || true
              RESTART_SUCCESS=1
              DEPLOYMENT_METHOD="deploy.sh"
            fi

            if [ ${RESTART_SUCCESS} -eq 0 ]; then
              echo "⚠️ Deployment completed but restart could not be verified automatically."
            else
              echo "✅ Restart completed via ${DEPLOYMENT_METHOD}"
            fi

            echo "[5/6] Waiting for services to stabilise..."
            sleep 10

            echo "[6/6] Running health checks..."
            HEALTH_OK=1

            if curl -sf http://127.0.0.1:8000/health >/dev/null 2>&1; then
              echo "✓ Backend API healthy (http://127.0.0.1:8000/health)"
            else
              echo "❌ Backend API health check failed (http://127.0.0.1:8000/health)"
              HEALTH_OK=0
            fi

            if curl -sf https://erp.tsh.sale/health >/dev/null 2>&1; then
              echo "✓ Public endpoint healthy (https://erp.tsh.sale/health)"
            else
              echo "⚠️ Warning: Public endpoint not reachable (https://erp.tsh.sale/health)"
            fi

            if [ ${HEALTH_OK} -eq 0 ]; then
              echo "❌ Deployment verification failed"
              exit 1
            fi

            echo "========================================"
            echo "✅ Deployment Successful!"
            echo "========================================"
            echo "Backend: https://erp.tsh.sale"
            echo "API Docs: https://erp.tsh.sale/docs"
            echo "Health: https://erp.tsh.sale/health"
            echo "========================================"

      - name: Notify on success
        if: success()
        run: |
          echo "✅ Deployment to production completed successfully"
          # Add Slack/Discord/Telegram notification here if needed

      - name: Notify on failure
        if: failure()
        run: |
          echo "❌ Deployment failed!"
          # Add Slack/Discord/Telegram notification here if needed
