name: Send Notification

on:
  workflow_call:
    inputs:
      notification_type:
        description: 'Type of notification (deployment, ci, security, rollback, weekly-report)'
        required: true
        type: string
      status:
        description: 'Status (success, failure, warning, info)'
        required: true
        type: string
      environment:
        description: 'Environment (production, staging, development)'
        required: false
        type: string
        default: ''
      service:
        description: 'Service name (app, neurolink, tds-admin)'
        required: false
        type: string
        default: ''
      version:
        description: 'Version or tag'
        required: false
        type: string
        default: ''
      duration:
        description: 'Duration in seconds'
        required: false
        type: string
        default: ''
      details:
        description: 'Additional details or message'
        required: false
        type: string
        default: ''
      test_results:
        description: 'Test results summary (passed/failed/total)'
        required: false
        type: string
        default: ''
      security_findings:
        description: 'Security findings summary'
        required: false
        type: string
        default: ''
      run_url:
        description: 'GitHub Actions run URL'
        required: false
        type: string
        default: ''

jobs:
  send-telegram:
    name: Send Telegram Notification
    runs-on: ubuntu-latest

    steps:
      - name: Determine emoji and title
        id: meta
        run: |
          case "${{ inputs.notification_type }}" in
            deployment)
              echo "emoji=ðŸš€" >> $GITHUB_OUTPUT
              echo "title=Deployment" >> $GITHUB_OUTPUT
              ;;
            ci)
              echo "emoji=ðŸ”" >> $GITHUB_OUTPUT
              echo "title=CI Pipeline" >> $GITHUB_OUTPUT
              ;;
            security)
              echo "emoji=ðŸ”’" >> $GITHUB_OUTPUT
              echo "title=Security Scan" >> $GITHUB_OUTPUT
              ;;
            rollback)
              echo "emoji=âª" >> $GITHUB_OUTPUT
              echo "title=Rollback" >> $GITHUB_OUTPUT
              ;;
            weekly-report)
              echo "emoji=ðŸ“Š" >> $GITHUB_OUTPUT
              echo "title=Weekly DevOps Report" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "emoji=â„¹ï¸" >> $GITHUB_OUTPUT
              echo "title=Notification" >> $GITHUB_OUTPUT
              ;;
          esac

          case "${{ inputs.status }}" in
            success)
              echo "status_emoji=âœ…" >> $GITHUB_OUTPUT
              ;;
            failure)
              echo "status_emoji=âŒ" >> $GITHUB_OUTPUT
              ;;
            warning)
              echo "status_emoji=âš ï¸" >> $GITHUB_OUTPUT
              ;;
            info)
              echo "status_emoji=â„¹ï¸" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Build Telegram message
        id: message
        run: |
          # Build simple single-line message
          MESSAGE="TSH ERP - ${{ inputs.status }} - Branch: ${{ github.ref_name }} - Commit: ${GITHUB_SHA:0:7} - By: ${{ github.actor }}"

          # Add environment if provided
          if [ -n "${{ inputs.environment }}" ]; then
            MESSAGE="$MESSAGE - Env: ${{ inputs.environment }}"
          fi

          # Add service if provided
          if [ -n "${{ inputs.service }}" ]; then
            MESSAGE="$MESSAGE - Service: ${{ inputs.service }}"
          fi

          # Add version if provided
          if [ -n "${{ inputs.version }}" ]; then
            MESSAGE="$MESSAGE - Version: ${{ inputs.version }}"
          fi

          # Add security findings if provided
          if [ -n "${{ inputs.security_findings }}" ]; then
            MESSAGE="$MESSAGE - Security: ${{ inputs.security_findings }}"
          fi

          # Add run URL
          RUN_URL="${{ inputs.run_url }}"
          if [ -z "$RUN_URL" ]; then
            RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          fi
          MESSAGE="$MESSAGE - View: $RUN_URL"

          # Save message
          echo "$MESSAGE" > /tmp/telegram_message.txt
          echo "message_file=/tmp/telegram_message.txt" >> $GITHUB_OUTPUT

      - name: Send to Telegram
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "Telegram credentials not configured, skipping notification"
            exit 0
          fi

          MESSAGE=$(cat ${{ steps.message.outputs.message_file }})

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="$MESSAGE" \
            -d parse_mode="Markdown" \
            -d disable_web_page_preview=true

      - name: Log notification sent
        run: |
          echo "âœ… Telegram notification sent successfully"
          echo "Type: ${{ inputs.notification_type }}"
          echo "Status: ${{ inputs.status }}"

  send-email:
    name: Send Email Notification
    runs-on: ubuntu-latest
    if: inputs.status == 'failure' || inputs.notification_type == 'weekly-report'

    steps:
      - name: Determine email subject
        id: subject
        run: |
          case "${{ inputs.notification_type }}" in
            deployment)
              SUBJECT="Deployment ${{ inputs.status }} - ${{ inputs.environment }}"
              ;;
            ci)
              SUBJECT="CI Pipeline ${{ inputs.status }} - ${{ github.ref_name }}"
              ;;
            security)
              SUBJECT="Security Scan ${{ inputs.status }}"
              ;;
            rollback)
              SUBJECT="Rollback Executed - ${{ inputs.environment }}"
              ;;
            weekly-report)
              SUBJECT="Weekly DevOps Report - $(date +%Y-%m-%d)"
              ;;
            *)
              SUBJECT="TSH ERP Notification - ${{ inputs.status }}"
              ;;
          esac

          echo "subject=[TSH ERP] $SUBJECT" >> $GITHUB_OUTPUT

      - name: Build email body
        id: email
        run: |
          cat > /tmp/email_body.html <<EOF
          <!DOCTYPE html>
          <html>
          <head>
            <style>
              body { font-family: Arial, sans-serif; line-height: 1.6; }
              .header { background-color: #0066cc; color: white; padding: 20px; }
              .content { padding: 20px; }
              .status-success { color: #28a745; }
              .status-failure { color: #dc3545; }
              .status-warning { color: #ffc107; }
              .status-info { color: #17a2b8; }
              table { border-collapse: collapse; width: 100%; }
              th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
              th { background-color: #f2f2f2; }
              .footer { margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 12px; color: #666; }
            </style>
          </head>
          <body>
            <div class="header">
              <h1>TSH ERP - ${{ inputs.notification_type }}</h1>
            </div>
            <div class="content">
              <h2 class="status-${{ inputs.status }}">Status: ${{ inputs.status }}</h2>

              <table>
                <tr><th>Property</th><th>Value</th></tr>
                <tr><td>Environment</td><td>${{ inputs.environment || 'N/A' }}</td></tr>
                <tr><td>Service</td><td>${{ inputs.service || 'N/A' }}</td></tr>
                <tr><td>Version</td><td>${{ inputs.version || 'N/A' }}</td></tr>
                <tr><td>Branch</td><td>${{ github.ref_name }}</td></tr>
                <tr><td>Commit</td><td>${GITHUB_SHA:0:7}</td></tr>
                <tr><td>Triggered by</td><td>${{ github.actor }}</td></tr>
                <tr><td>Duration</td><td>${{ inputs.duration || 'N/A' }} seconds</td></tr>
              </table>

              ${{ inputs.test_results && format('<h3>Test Results</h3><p>{0}</p>', inputs.test_results) || '' }}
              ${{ inputs.security_findings && format('<h3>Security Findings</h3><p>{0}</p>', inputs.security_findings) || '' }}
              ${{ inputs.details && format('<h3>Details</h3><p>{0}</p>', inputs.details) || '' }}

              <p><a href="${{ inputs.run_url || format('{0}/{1}/actions/runs/{2}', github.server_url, github.repository, github.run_id) }}">View full details on GitHub</a></p>
            </div>
            <div class="footer">
              <p>This is an automated notification from TSH ERP CI/CD Pipeline.</p>
              <p>Generated on $(date -u +'%Y-%m-%d %H:%M:%S UTC')</p>
            </div>
          </body>
          </html>
          EOF

          echo "body_file=/tmp/email_body.html" >> $GITHUB_OUTPUT

      - name: Check email configuration
        id: check-email
        env:
          EMAIL_SMTP_HOST: ${{ secrets.EMAIL_SMTP_HOST }}
        run: |
          if [ -n "$EMAIL_SMTP_HOST" ]; then
            echo "configured=true" >> $GITHUB_OUTPUT
          else
            echo "configured=false" >> $GITHUB_OUTPUT
            echo "Email SMTP not configured, skipping email notification"
          fi

      - name: Send email
        if: steps.check-email.outputs.configured == 'true'
        uses: dawidd6/action-send-mail@v6
        with:
          server_address: ${{ secrets.EMAIL_SMTP_HOST }}
          server_port: ${{ secrets.EMAIL_SMTP_PORT || 465 }}
          username: ${{ secrets.EMAIL_SMTP_USER }}
          password: ${{ secrets.EMAIL_SMTP_PASSWORD }}
          subject: ${{ steps.subject.outputs.subject }}
          to: ${{ secrets.EMAIL_NOTIFICATION_TO || 'devops@tsh.sale' }}
          from: ${{ secrets.EMAIL_NOTIFICATION_FROM || 'github-actions@tsh.sale' }}
          html_body: file://${{ steps.email.outputs.body_file }}

      - name: Log email sent
        run: |
          echo "âœ… Email notification sent successfully"
          echo "Subject: ${{ steps.subject.outputs.subject }}"
