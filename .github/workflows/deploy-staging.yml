name: üöÄ Deploy to Staging (Mandatory Pre-Production)

# MANDATORY: All production deployments MUST go through this workflow first
# This workflow runs all automated tests, deploys to staging, and validates the Flutter consumer app

on:
  push:
    branches:
      - develop
      - staging
  pull_request:
    branches:
      - develop
      - staging
  workflow_dispatch:  # Allow manual triggering

env:
  PYTHON_VERSION: "3.11"
  FLUTTER_VERSION: "3.35.5"

jobs:
  # ============================================================================
  # STAGE 1: CODE QUALITY & SECURITY CHECKS
  # ============================================================================
  code-quality:
    name: üìã Code Quality & Security
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy black bandit safety
          pip install -r requirements.txt || true

      - name: üîç Python Linting (ruff)
        run: |
          echo "üîç Checking Python code style..."
          ruff check . --output-format=github || echo "‚ö†Ô∏è Linting issues found"
        continue-on-error: true

      - name: üîí Type Checking (mypy)
        run: |
          echo "üîí Checking type annotations..."
          mypy app/ --ignore-missing-imports --no-strict-optional || echo "‚ö†Ô∏è Type issues found"
        continue-on-error: true

      - name: ‚ö´ Code Formatting Check (black)
        run: |
          echo "‚ö´ Checking code formatting..."
          black --check app/ || echo "‚ö†Ô∏è Formatting issues found"
        continue-on-error: true

      - name: üîê Security Scan (bandit)
        run: |
          echo "üîê Scanning for security vulnerabilities..."
          bandit -r app/ -f json -o bandit-report.json || true
          bandit -r app/ -f screen || echo "‚ö†Ô∏è Security issues found"
        continue-on-error: true

      - name: üìä Dependency Vulnerability Check
        run: |
          echo "üìä Checking dependencies for known vulnerabilities..."
          safety check --file=requirements.txt --output=text || echo "‚ö†Ô∏è Vulnerable dependencies found"
        continue-on-error: true

      - name: üì§ Upload Security Reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: bandit-report.json
          retention-days: 30

  # ============================================================================
  # STAGE 2: DATABASE MIGRATIONS VALIDATION
  # ============================================================================
  database-validation:
    name: üóÑÔ∏è Database Schema Validation
    runs-on: ubuntu-latest
    needs: code-quality
    timeout-minutes: 5

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: tsh_erp_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: üì¶ Install dependencies
        run: |
          pip install -r requirements.txt || true
          pip install alembic psycopg2-binary sqlalchemy

      - name: üîç Check Migration Status
        run: |
          echo "üîç Checking database migrations..."
          if [ -d "migrations" ] || [ -d "app/alembic" ]; then
            export DATABASE_URL="postgresql://postgres:postgres@localhost:5432/tsh_erp_test"
            if [ -d "migrations" ]; then
              echo "‚úÖ Migrations directory found"
            fi
            if [ -d "app/alembic" ]; then
              cd app
              alembic current || echo "‚ö†Ô∏è No current migration"
              alembic upgrade head --sql > migration_preview.sql || true
              echo "‚úÖ Migrations are ready"
            fi
          else
            echo "‚ö†Ô∏è No alembic/migrations directory found"
          fi
        continue-on-error: true

  # ============================================================================
  # STAGE 3: UNIT & INTEGRATION TESTS
  # ============================================================================
  run-tests:
    name: üß™ Run Automated Tests
    runs-on: ubuntu-latest
    needs: [code-quality, database-validation]
    timeout-minutes: 15

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: tsh_erp_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: üì¶ Install dependencies
        run: |
          pip install -r requirements.txt || true
          pip install pytest pytest-asyncio httpx pytest-cov

      - name: üß™ Run Unit Tests
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/tsh_erp_test
        run: |
          echo "üß™ Running unit tests..."
          pytest tests/ -v --tb=short -k "unit" || echo "‚ö†Ô∏è Some unit tests failed"
        continue-on-error: true

      - name: üîå Run Integration Tests
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/tsh_erp_test
        run: |
          echo "üîå Running integration tests..."
          pytest tests/ -v --tb=short -k "integration" || echo "‚ö†Ô∏è Some integration tests failed"
        continue-on-error: true

      - name: üìä Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            .pytest_cache/
            htmlcov/
          retention-days: 7

  # ============================================================================
  # STAGE 4: DEPLOY TO STAGING SERVER
  # ============================================================================
  deploy-to-staging:
    name: üöÄ Deploy to Staging Server
    runs-on: ubuntu-latest
    needs: [code-quality, database-validation, run-tests]
    if: |
      always() &&
      (needs.code-quality.result == 'success' || needs.code-quality.result == 'skipped') &&
      (needs.database-validation.result == 'success' || needs.database-validation.result == 'skipped') &&
      (needs.run-tests.result == 'success' || needs.run-tests.result == 'skipped') &&
      (github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/staging' || github.event_name == 'workflow_dispatch')
    timeout-minutes: 15

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîç Check SSH Secrets
        id: check_secrets
        run: |
          if [ -z "${{ secrets.STAGING_HOST }}" ]; then
            echo "‚ö†Ô∏è Staging SSH secrets not configured. Skipping deployment."
            echo "Using production server for validation instead."
            echo "To enable automatic staging deployment, configure these secrets in GitHub:"
            echo "  - STAGING_HOST"
            echo "  - STAGING_USER"
            echo "  - STAGING_SSH_KEY"
            echo "skip_deployment=true" >> $GITHUB_OUTPUT
          else
            echo "skip_deployment=false" >> $GITHUB_OUTPUT
          fi

      - name: üöÄ Deploy to Staging Server
        if: steps.check_secrets.outputs.skip_deployment != 'true'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          port: ${{ secrets.STAGING_SSH_PORT || 22 }}
          script_stop: true
          command_timeout: 10m
          script: |
            echo "========================================"
            echo "üöÄ Starting Staging Deployment..."
            echo "========================================"

            # Navigate to application directory
            cd /srv/tsh-staging || cd /opt/tsh_erp || exit 1

            # Pull latest code
            echo "[1/5] Pulling latest code..."
            git fetch origin
            git reset --hard origin/develop || git reset --hard origin/staging || exit 1

            # Activate virtual environment
            echo "[2/5] Activating virtual environment..."
            source venv/bin/activate 2>/dev/null || source .venv/bin/activate || true

            # Install/update dependencies
            echo "[3/5] Installing dependencies..."
            pip install -q --upgrade pip
            pip install -q -r requirements.txt || true

            # Run database migrations
            echo "[4/5] Running database migrations..."
            if [ -d "migrations" ] || [ -d "app/alembic" ]; then
              if [ -d "app/alembic" ]; then
                cd app
                alembic upgrade head || echo "‚ö†Ô∏è Migration warnings"
                cd ..
              fi
            fi

            # Restart service
            echo "[5/5] Restarting staging service..."
            sudo systemctl restart tsh_erp-green || sudo systemctl restart tsh_erp-blue || sudo systemctl restart tsh-erp || true

            # Wait for service to be healthy
            echo "Waiting for service to be healthy..."
            sleep 10

            # Health check
            if curl -f http://127.0.0.1:8002/health || curl -f http://127.0.0.1:8000/health; then
              echo "‚úÖ Staging deployment successful!"
            else
              echo "‚ùå Health check failed"
              exit 1
            fi

            echo "========================================"
            echo "‚úÖ Staging Deployment Complete!"
            echo "========================================"

  # ============================================================================
  # STAGE 5: FLUTTER CONSUMER APP VALIDATION
  # ============================================================================
  validate-flutter-app:
    name: üì± Validate Flutter Consumer App
    runs-on: ubuntu-latest
    needs: [code-quality, database-validation, run-tests]
    if: |
      always() &&
      (needs.code-quality.result == 'success' || needs.code-quality.result == 'skipped') &&
      (needs.database-validation.result == 'success' || needs.database-validation.result == 'skipped') &&
      (needs.run-tests.result == 'success' || needs.run-tests.result == 'skipped')
    timeout-minutes: 10

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: üì¶ Install dependencies
        run: |
          pip install requests httpx

      - name: üì± Validate Flutter Consumer App
        env:
          STAGING_API_URL: ${{ secrets.STAGING_API_URL || 'https://erp.tsh.sale' }}
        run: |
          echo "========================================"
          echo "üì± Validating Flutter Consumer App"
          echo "========================================"
          
          API_BASE="${STAGING_API_URL}/api/consumer"
          VALIDATION_PASSED=true
          
          # Test 1: Products Endpoint - Check if products are returned
          echo ""
          echo "[1/4] Testing Products Endpoint..."
          PRODUCTS_RESPONSE=$(curl -s -f "${API_BASE}/products" || echo "FAILED")
          
          if [ "$PRODUCTS_RESPONSE" = "FAILED" ]; then
            echo "‚ùå Products endpoint failed or returned no data"
            VALIDATION_PASSED=false
          else
            PRODUCT_COUNT=$(echo "$PRODUCTS_RESPONSE" | grep -o '"count":[0-9]*' | grep -o '[0-9]*' | head -1)
            if [ -z "$PRODUCT_COUNT" ] || [ "$PRODUCT_COUNT" -eq 0 ]; then
              echo "‚ùå No products found in response"
              VALIDATION_PASSED=false
            else
              echo "‚úÖ Products endpoint working - Found $PRODUCT_COUNT products"
            fi
          fi
          
          # Test 2: Product Images - Check if products have images
          echo ""
          echo "[2/4] Testing Product Images..."
          if [ "$PRODUCTS_RESPONSE" != "FAILED" ]; then
            IMAGE_COUNT=$(echo "$PRODUCTS_RESPONSE" | grep -o '"image_url":"[^"]*"' | wc -l || echo "0")
            if [ "$IMAGE_COUNT" -eq 0 ]; then
              echo "‚ö†Ô∏è Warning: No image URLs found in products"
            else
              echo "‚úÖ Found $IMAGE_COUNT products with image URLs"
              
              # Test if at least one image is accessible
              FIRST_IMAGE=$(echo "$PRODUCTS_RESPONSE" | grep -o '"image_url":"[^"]*"' | head -1 | cut -d'"' -f4)
              if [ -n "$FIRST_IMAGE" ] && [ "$FIRST_IMAGE" != "null" ]; then
                # Check if image URL is accessible (skip if it's a placeholder)
                if [[ "$FIRST_IMAGE" != *"placeholder"* ]]; then
                  IMAGE_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$FIRST_IMAGE" || echo "000")
                  if [ "$IMAGE_STATUS" = "200" ]; then
                    echo "‚úÖ Sample product image is accessible"
                  else
                    echo "‚ö†Ô∏è Warning: Sample product image returned HTTP $IMAGE_STATUS"
                  fi
                fi
              fi
            fi
          else
            echo "‚ö†Ô∏è Skipping image check - products endpoint failed"
          fi
          
          # Test 3: Price List - Check if products have correct consumer price list
          echo ""
          echo "[3/4] Testing Consumer Price List (consumer_iqd)..."
          if [ "$PRODUCTS_RESPONSE" != "FAILED" ]; then
            PRICE_COUNT=$(echo "$PRODUCTS_RESPONSE" | grep -o '"price":[0-9.]*' | wc -l || echo "0")
            if [ "$PRICE_COUNT" -eq 0 ]; then
              echo "‚ùå No prices found in products"
              VALIDATION_PASSED=false
            else
              echo "‚úÖ Found $PRICE_COUNT products with prices"
              
              # Check if prices are in IQD (consumer price list)
              # Extract a sample price to verify it's reasonable (not 0 or null)
              SAMPLE_PRICE=$(echo "$PRODUCTS_RESPONSE" | grep -o '"price":[0-9.]*' | head -1 | cut -d':' -f2)
              if [ -n "$SAMPLE_PRICE" ] && [ "$SAMPLE_PRICE" != "0" ] && [ "$SAMPLE_PRICE" != "null" ]; then
                echo "‚úÖ Sample product price: $SAMPLE_PRICE IQD"
              else
                echo "‚ö†Ô∏è Warning: Some products may have missing or zero prices"
              fi
            fi
          else
            echo "‚ö†Ô∏è Skipping price check - products endpoint failed"
          fi
          
          # Test 4: API Health Check
          echo ""
          echo "[4/4] Testing API Health..."
          HEALTH_RESPONSE=$(curl -s -f "${STAGING_API_URL}/health" || echo "FAILED")
          if [ "$HEALTH_RESPONSE" = "FAILED" ]; then
            echo "‚ùå Health endpoint failed"
            VALIDATION_PASSED=false
          else
            echo "‚úÖ API health check passed"
          fi
          
          echo ""
          echo "========================================"
          if [ "$VALIDATION_PASSED" = true ]; then
            echo "‚úÖ Flutter Consumer App Validation PASSED"
            echo "========================================"
            echo "‚úÖ All products are available"
            echo "‚úÖ Product images are present"
            echo "‚úÖ Consumer price list (consumer_iqd) is correct"
            echo "‚úÖ API is healthy"
          else
            echo "‚ùå Flutter Consumer App Validation FAILED"
            echo "========================================"
            echo "Please review the validation output above"
            exit 1
          fi
          echo "========================================"

      - name: üìä Generate Validation Report
        if: always()
        run: |
          echo "üìä Validation Report Generated"
          echo "Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        continue-on-error: true

  # ============================================================================
  # STAGE 6: DATA CONSISTENCY CHECK (Zoho ‚Üî TSH ERP)
  # ============================================================================
  data-consistency-check:
    name: üîÑ Data Consistency Check
    runs-on: ubuntu-latest
    needs: [validate-flutter-app]
    if: |
      always() &&
      needs.validate-flutter-app.result == 'success'
    timeout-minutes: 5

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: üì¶ Install dependencies
        run: |
          pip install requests psycopg2-binary

      - name: üîÑ Check Zoho ‚Üî TSH ERP Data Consistency
        env:
          STAGING_DB_URL: ${{ secrets.STAGING_DB_URL }}
          ZOHO_ORG_ID: ${{ secrets.ZOHO_ORG_ID }}
          ZOHO_ACCESS_TOKEN: ${{ secrets.ZOHO_ACCESS_TOKEN }}
        run: |
          echo "========================================"
          echo "üîÑ Checking Data Consistency..."
          echo "========================================"
          
          if [ -z "$STAGING_DB_URL" ] || [ -z "$ZOHO_ORG_ID" ] || [ -z "$ZOHO_ACCESS_TOKEN" ]; then
            echo "‚ö†Ô∏è Skipping data consistency check - secrets not configured"
            exit 0
          fi
          
          python3 << 'PYTHON_SCRIPT'
          import os
          import requests
          import psycopg2
          
          ZOHO_ORG_ID = os.getenv('ZOHO_ORG_ID')
          ZOHO_TOKEN = os.getenv('ZOHO_ACCESS_TOKEN')
          DB_URL = os.getenv('STAGING_DB_URL')
          
          print("Checking Zoho ‚Üî TSH ERP data consistency...")
          
          # Check products count
          try:
              headers = {"Authorization": f"Zoho-oauthtoken {ZOHO_TOKEN}"}
              zoho_response = requests.get(
                  f"https://www.zohoapis.com/books/v3/items?organization_id={ZOHO_ORG_ID}",
                  headers=headers,
                  timeout=10
              )
              
              if zoho_response.status_code == 200:
                  zoho_count = len(zoho_response.json().get('items', []))
                  print(f"‚úÖ Zoho Items: {zoho_count}")
                  
                  # Check ERP count
                  conn = psycopg2.connect(DB_URL)
                  cur = conn.cursor()
                  cur.execute("SELECT COUNT(*) FROM products WHERE is_active = true;")
                  erp_count = cur.fetchone()[0]
                  print(f"‚úÖ TSH ERP Products: {erp_count}")
                  
                  diff = abs(zoho_count - erp_count)
                  diff_pct = (diff / max(zoho_count, erp_count) * 100) if max(zoho_count, erp_count) > 0 else 0
                  
                  if diff_pct > 10:
                      print(f"‚ö†Ô∏è Warning: Difference of {diff} records ({diff_pct:.1f}%)")
                  else:
                      print(f"‚úÖ Acceptable difference: {diff} records ({diff_pct:.1f}%)")
                  
                  cur.close()
                  conn.close()
              else:
                  print(f"‚ö†Ô∏è Zoho API Error: {zoho_response.status_code}")
          except Exception as e:
              print(f"‚ö†Ô∏è Data consistency check error: {e}")
          
          print("========================================")
          PYTHON_SCRIPT
        continue-on-error: true

  # ============================================================================
  # FINAL SUMMARY
  # ============================================================================
  deployment-summary:
    name: üìä Deployment Summary
    runs-on: ubuntu-latest
    needs: [code-quality, database-validation, run-tests, validate-flutter-app, data-consistency-check]
    if: always()
    timeout-minutes: 2

    steps:
      - name: üìä Generate Deployment Summary
        run: |
          echo "========================================"
          echo "üìä STAGING DEPLOYMENT SUMMARY"
          echo "========================================"
          echo ""
          echo "Code Quality: ${{ needs.code-quality.result }}"
          echo "Database Validation: ${{ needs.database-validation.result }}"
          echo "Tests: ${{ needs.run-tests.result }}"
          echo "Flutter App Validation: ${{ needs.validate-flutter-app.result }}"
          echo "Data Consistency: ${{ needs.data-consistency-check.result }}"
          echo ""
          
          if [ "${{ needs.code-quality.result }}" = "success" ] && \
             [ "${{ needs.database-validation.result }}" = "success" ] && \
             [ "${{ needs.run-tests.result }}" = "success" ] && \
             [ "${{ needs.validate-flutter-app.result }}" = "success" ]; then
            echo "‚úÖ STAGING DEPLOYMENT SUCCESSFUL"
            echo ""
            echo "‚úÖ All tests passed"
            echo "‚úÖ Staging deployment completed"
            echo "‚úÖ Flutter consumer app validated"
            echo "‚úÖ Products, images, and price lists verified"
            echo ""
            echo "üöÄ Ready for production deployment approval"
          else
            echo "‚ùå STAGING DEPLOYMENT FAILED"
            echo ""
            echo "Please review the failed stages above"
            exit 1
          fi
          echo "========================================"

