name: üöÄ Deploy to Staging (Mandatory Pre-Production)

# MANDATORY: All production deployments MUST go through this workflow first
# This workflow runs all automated tests, deploys to staging, and validates the Flutter consumer app

on:
  push:
    branches:
      - develop
      - staging
  pull_request:
    branches:
      - develop
      - staging
  workflow_dispatch:  # Allow manual triggering

env:
  PYTHON_VERSION: "3.11"
  FLUTTER_VERSION: "3.35.5"
  ENABLE_AUTO_MERGE: ${{ secrets.ENABLE_AUTO_MERGE || 'false' }}

jobs:
  # ============================================================================
  # STAGE 1: CODE QUALITY & SECURITY CHECKS
  # ============================================================================
  code-quality:
    name: üìã Code Quality & Security
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy black bandit safety
          pip install -r requirements.txt || true

      - name: üîç Python Linting (ruff)
        run: |
          echo "üîç Checking Python code style..."
          ruff check . --output-format=github || echo "‚ö†Ô∏è Linting issues found"
        continue-on-error: true

      - name: üîí Type Checking (mypy)
        run: |
          echo "üîí Checking type annotations..."
          mypy app/ --ignore-missing-imports --no-strict-optional || echo "‚ö†Ô∏è Type issues found"
        continue-on-error: true

      - name: ‚ö´ Code Formatting Check (black)
        run: |
          echo "‚ö´ Checking code formatting..."
          black --check app/ || echo "‚ö†Ô∏è Formatting issues found"
        continue-on-error: true

      - name: üîê Security Scan (bandit)
        run: |
          echo "üîê Scanning for security vulnerabilities..."
          bandit -r app/ -f json -o bandit-report.json || true
          bandit -r app/ -f screen || echo "‚ö†Ô∏è Security issues found"
        continue-on-error: true

      - name: üìä Dependency Vulnerability Check
        run: |
          echo "üìä Checking dependencies for known vulnerabilities..."
          safety check --file=requirements.txt --output=text || echo "‚ö†Ô∏è Vulnerable dependencies found"
        continue-on-error: true

      - name: üì§ Upload Security Reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: bandit-report.json
          retention-days: 30

  # ============================================================================
  # STAGE 2: DATABASE MIGRATIONS VALIDATION
  # ============================================================================
  database-validation:
    name: üóÑÔ∏è Database Schema Validation
    runs-on: ubuntu-latest
    needs: code-quality
    timeout-minutes: 5

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: tsh_erp_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: üì¶ Install dependencies
        run: |
          pip install -r requirements.txt || true
          pip install alembic psycopg2-binary sqlalchemy

      - name: üîç Check Migration Status
        run: |
          echo "üîç Checking database migrations..."
          if [ -d "migrations" ] || [ -d "app/alembic" ]; then
            export DATABASE_URL="postgresql://postgres:postgres@localhost:5432/tsh_erp_test"
            if [ -d "migrations" ]; then
              echo "‚úÖ Migrations directory found"
            fi
            if [ -d "app/alembic" ]; then
              cd app
              alembic current || echo "‚ö†Ô∏è No current migration"
              alembic upgrade head --sql > migration_preview.sql || true
              echo "‚úÖ Migrations are ready"
            fi
          else
            echo "‚ö†Ô∏è No alembic/migrations directory found"
          fi
        continue-on-error: true

  # ============================================================================
  # STAGE 2.5: CONSUMER PRICE LIST VALIDATION (CRITICAL)
  # ============================================================================
  validate-consumer-pricelist:
    name: üí∞ Consumer Price List Validation
    runs-on: ubuntu-latest
    needs: [code-quality, database-validation]
    timeout-minutes: 5

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: tsh_erp_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: üì¶ Install dependencies
        run: |
          pip install -r requirements.txt || true
          pip install psycopg2-binary sqlalchemy

      - name: üí∞ Validate Consumer Price List
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/tsh_erp_test
          # Use production database if staging DB not available
          PROD_DB_URL: ${{ secrets.PROD_DB_URL }}
        run: |
          echo "========================================"
          echo "üí∞ Consumer Price List Validation"
          echo "========================================"
          
          # Check if we should use production database
          if [ -n "$PROD_DB_URL" ]; then
            echo "‚ö†Ô∏è Using production database for validation (staging DB not configured)"
            export DATABASE_URL="$PROD_DB_URL"
          fi
          
          # Run validation script
          python3 scripts/validate_consumer_pricelist.py || {
            echo ""
            echo "‚ùå CRITICAL: Consumer Price List validation FAILED"
            echo ""
            echo "This means some products with stock are missing Consumer price list prices."
            echo "The Consumer app will NOT display these products correctly."
            echo ""
            echo "Required actions:"
            echo "1. Sync Consumer price list from Zoho"
            echo "2. Ensure all products have Consumer price list prices"
            echo "3. Re-run validation"
            exit 1
          }
          
          echo ""
          echo "‚úÖ Consumer Price List validation PASSED"
          echo "========================================"

  # ============================================================================
  # STAGE 3: UNIT & INTEGRATION TESTS
  # ============================================================================
  run-tests:
    name: üß™ Run Automated Tests
    runs-on: ubuntu-latest
    needs: [code-quality, database-validation, validate-consumer-pricelist]
    timeout-minutes: 15

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: tsh_erp_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: üì¶ Install dependencies
        run: |
          pip install -r requirements.txt || true
          pip install pytest pytest-asyncio httpx pytest-cov

      - name: üß™ Run Unit Tests
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/tsh_erp_test
        run: |
          echo "üß™ Running unit tests..."
          pytest tests/ -v --tb=short -k "unit" || echo "‚ö†Ô∏è Some unit tests failed"
        continue-on-error: true

      - name: üîå Run Integration Tests
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/tsh_erp_test
        run: |
          echo "üîå Running integration tests..."
          pytest tests/ -v --tb=short -k "integration" || echo "‚ö†Ô∏è Some integration tests failed"
        continue-on-error: true

      - name: üìä Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            .pytest_cache/
            htmlcov/
          retention-days: 7

  # ============================================================================
  # STAGE 4: DEPLOY TO STAGING SERVER
  # ============================================================================
  deploy-to-staging:
    name: üöÄ Deploy to Staging Server
    runs-on: ubuntu-latest
    needs: [code-quality, database-validation, run-tests]
    if: |
      always() &&
      (needs.code-quality.result == 'success' || needs.code-quality.result == 'skipped') &&
      (needs.database-validation.result == 'success' || needs.database-validation.result == 'skipped') &&
      (needs.run-tests.result == 'success' || needs.run-tests.result == 'skipped') &&
      (github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/staging' || github.event_name == 'workflow_dispatch')
    timeout-minutes: 15

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîç Check SSH Secrets
        id: check_secrets
        run: |
          if [ -z "${{ secrets.STAGING_HOST }}" ]; then
            echo "‚ö†Ô∏è Staging SSH secrets not configured. Skipping deployment."
            echo "Using production server for validation instead."
            echo "To enable automatic staging deployment, configure these secrets in GitHub:"
            echo "  - STAGING_HOST"
            echo "  - STAGING_USER"
            echo "  - STAGING_SSH_KEY"
            echo "skip_deployment=true" >> $GITHUB_OUTPUT
          else
            echo "skip_deployment=false" >> $GITHUB_OUTPUT
          fi

      - name: üöÄ Deploy to Staging Server
        if: steps.check_secrets.outputs.skip_deployment != 'true'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          port: ${{ secrets.STAGING_SSH_PORT || 22 }}
          script_stop: true
          command_timeout: 10m
          script: |
            echo "========================================"
            echo "üöÄ Starting Staging Deployment..."
            echo "========================================"

            # Navigate to application directory
            cd /srv/tsh-staging || cd /opt/tsh_erp || exit 1

            # Pull latest code
            echo "[1/5] Pulling latest code..."
            git fetch origin
            git reset --hard origin/develop || git reset --hard origin/staging || exit 1

            # Activate virtual environment
            echo "[2/5] Activating virtual environment..."
            source venv/bin/activate 2>/dev/null || source .venv/bin/activate || true

            # Install/update dependencies
            echo "[3/5] Installing dependencies..."
            pip install -q --upgrade pip
            pip install -q -r requirements.txt || true

            # Run database migrations
            echo "[4/5] Running database migrations..."
            if [ -d "migrations" ] || [ -d "app/alembic" ]; then
              if [ -d "app/alembic" ]; then
                cd app
                alembic upgrade head || echo "‚ö†Ô∏è Migration warnings"
                cd ..
              fi
            fi

            # Restart service
            echo "[5/5] Restarting staging service..."
            sudo systemctl restart tsh_erp-green || sudo systemctl restart tsh_erp-blue || sudo systemctl restart tsh-erp || true

            # Wait for service to be healthy
            echo "Waiting for service to be healthy..."
            sleep 10

            # Health check
            if curl -f http://127.0.0.1:8002/health || curl -f http://127.0.0.1:8000/health; then
              echo "‚úÖ Staging deployment successful!"
            else
              echo "‚ùå Health check failed"
              exit 1
            fi

            echo "========================================"
            echo "‚úÖ Staging Deployment Complete!"
            echo "========================================"

  # ============================================================================
  # STAGE 5: FLUTTER CONSUMER APP VALIDATION
  # ============================================================================
  validate-flutter-app:
    name: üì± Validate Flutter Consumer App
    runs-on: ubuntu-latest
    needs: [code-quality, database-validation, run-tests]
    if: |
      always() &&
      (needs.code-quality.result == 'success' || needs.code-quality.result == 'skipped') &&
      (needs.database-validation.result == 'success' || needs.database-validation.result == 'skipped') &&
      (needs.run-tests.result == 'success' || needs.run-tests.result == 'skipped')
    timeout-minutes: 10

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: üì¶ Install dependencies
        run: |
          pip install requests httpx

      - name: üì± Validate Flutter Consumer App
        env:
          STAGING_API_URL: ${{ secrets.STAGING_API_URL || 'https://erp.tsh.sale' }}
        run: |
          echo "========================================"
          echo "üì± Validating Flutter Consumer App"
          echo "========================================"
          
          API_BASE="${STAGING_API_URL}/api/consumer"
          VALIDATION_PASSED=true
          
          # Test 1: Products Endpoint - Check if products are returned
          echo ""
          echo "[1/4] Testing Products Endpoint..."
          PRODUCTS_RESPONSE=$(curl -s -f "${API_BASE}/products" || echo "FAILED")
          
          if [ "$PRODUCTS_RESPONSE" = "FAILED" ]; then
            echo "‚ùå Products endpoint failed or returned no data"
            VALIDATION_PASSED=false
          else
            PRODUCT_COUNT=$(echo "$PRODUCTS_RESPONSE" | grep -o '"count":[0-9]*' | grep -o '[0-9]*' | head -1)
            if [ -z "$PRODUCT_COUNT" ] || [ "$PRODUCT_COUNT" -eq 0 ]; then
              echo "‚ùå No products found in response"
              VALIDATION_PASSED=false
            else
              echo "‚úÖ Products endpoint working - Found $PRODUCT_COUNT products"
            fi
          fi
          
          # Test 2: Product Images - Check if ALL products have images displayed
          echo ""
          echo "[2/5] Testing Product Images Display..."
          if [ "$PRODUCTS_RESPONSE" != "FAILED" ]; then
            # Count products with image URLs
            IMAGE_COUNT=$(echo "$PRODUCTS_RESPONSE" | grep -o '"image_url":"[^"]*"' | wc -l || echo "0")
            PRODUCT_COUNT_WITH_IMAGES=$(echo "$PRODUCTS_RESPONSE" | python3 -c "import sys, json; data=json.load(sys.stdin); items=data.get('items', []); print(sum(1 for item in items if item.get('image_url') and item.get('image_url') != 'null' and 'placeholder' not in item.get('image_url', '').lower()))" 2>/dev/null || echo "0")
            
            if [ "$IMAGE_COUNT" -eq 0 ]; then
              echo "‚ùå No image URLs found in products"
              VALIDATION_PASSED=false
            else
              echo "‚úÖ Found $IMAGE_COUNT products with image URLs"
              
              # Verify all products have images (or at least 95% have images)
              if [ -n "$PRODUCT_COUNT" ] && [ "$PRODUCT_COUNT" -gt 0 ]; then
                IMAGE_PERCENTAGE=$((PRODUCT_COUNT_WITH_IMAGES * 100 / PRODUCT_COUNT))
                if [ "$IMAGE_PERCENTAGE" -ge 95 ]; then
                  echo "‚úÖ $IMAGE_PERCENTAGE% of products have images ($PRODUCT_COUNT_WITH_IMAGES/$PRODUCT_COUNT)"
                else
                  echo "‚ö†Ô∏è Warning: Only $IMAGE_PERCENTAGE% of products have images ($PRODUCT_COUNT_WITH_IMAGES/$PRODUCT_COUNT)"
                fi
              fi
              
              # Test if at least one image is accessible
              FIRST_IMAGE=$(echo "$PRODUCTS_RESPONSE" | grep -o '"image_url":"[^"]*"' | head -1 | cut -d'"' -f4)
              if [ -n "$FIRST_IMAGE" ] && [ "$FIRST_IMAGE" != "null" ]; then
                # Check if image URL is accessible (skip if it's a placeholder)
                if [[ "$FIRST_IMAGE" != *"placeholder"* ]]; then
                  IMAGE_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$FIRST_IMAGE" || echo "000")
                  if [ "$IMAGE_STATUS" = "200" ]; then
                    echo "‚úÖ Sample product image is accessible (HTTP $IMAGE_STATUS)"
                  else
                    echo "‚ö†Ô∏è Warning: Sample product image returned HTTP $IMAGE_STATUS"
                  fi
                fi
              fi
            fi
          else
            echo "‚ö†Ô∏è Skipping image check - products endpoint failed"
            VALIDATION_PASSED=false
          fi
          
          # Test 3: Consumer Price List - CRITICAL: Verify ALL products display Consumer pricelist with price > 0
          # This test ensures the root cause fix is working (no base price fallback)
          echo ""
          echo "[3/5] Testing Consumer Price List Display (CRITICAL VALIDATION)..."
          echo "   Validating: Products MUST have Consumer price list prices (no base price fallback)"
          if [ "$PRODUCTS_RESPONSE" != "FAILED" ]; then
            # Use Python to properly parse JSON and validate prices
            PRICE_VALIDATION=$(echo "$PRODUCTS_RESPONSE" | python3 << 'PYTHON_SCRIPT'
import sys, json
try:
    data = json.load(sys.stdin)
    items = data.get('items', [])
    
    if not items:
        print("ERROR:NO_ITEMS")
        sys.exit(1)
    
    total_items = len(items)
    items_with_price = 0
    items_with_zero_price = 0
    items_with_null_price = 0
    items_with_iqd = 0
    items_with_base_price = 0  # Track if any products show base price (should be 0)
    
    for item in items:
        price = item.get('price')
        currency = item.get('currency', '')
        
        # Check if price looks like base price (very low prices might indicate base price)
        # This is a heuristic - Consumer prices should be reasonable
        if price is not None and price > 0 and price < 0.01:
            items_with_base_price += 1
        
        if price is None:
            items_with_null_price += 1
        elif price == 0 or price == 0.0:
            items_with_zero_price += 1
        elif price > 0:
            items_with_price += 1
        
        if currency == 'IQD':
            items_with_iqd += 1
    
    # CRITICAL: Fail if ANY product has zero or null price
    if items_with_zero_price > 0 or items_with_null_price > 0:
        print(f"ERROR:ZERO_PRICES|total={total_items}|with_price={items_with_price}|zero_price={items_with_zero_price}|null_price={items_with_null_price}|iqd={items_with_iqd}")
        sys.exit(1)
    
    # CRITICAL: Fail if not all products have IQD currency
    if items_with_iqd != total_items:
        print(f"ERROR:WRONG_CURRENCY|total={total_items}|iqd={items_with_iqd}")
        sys.exit(1)
    
    # WARNING: If many products have very low prices, might be base prices
    if items_with_base_price > total_items * 0.1:  # More than 10% have suspiciously low prices
        print(f"WARNING:SUSPICIOUS_PRICES|total={total_items}|suspicious={items_with_base_price}")
    
    print(f"SUCCESS|total={total_items}|with_price={items_with_price}|iqd={items_with_iqd}")
except Exception as e:
    print(f"ERROR:PARSE_ERROR|{str(e)}")
    sys.exit(1)
PYTHON_SCRIPT
)
            
            if echo "$PRICE_VALIDATION" | grep -q "ERROR:"; then
              echo "‚ùå CRITICAL: Consumer Price List validation FAILED"
              echo "$PRICE_VALIDATION"
              echo ""
              echo "Issues found:"
              if echo "$PRICE_VALIDATION" | grep -q "ZERO_PRICES"; then
                echo "  ‚ùå Products with zero or null prices detected"
                echo "  ‚ùå Consumer pricelist is not being applied correctly"
              fi
              if echo "$PRICE_VALIDATION" | grep -q "WRONG_CURRENCY"; then
                echo "  ‚ùå Not all products have IQD currency"
              fi
              VALIDATION_PASSED=false
            else
              echo "‚úÖ Consumer Price List validation PASSED"
              echo "$PRICE_VALIDATION"
            fi
          else
            echo "‚ùå CRITICAL: Products endpoint failed - cannot validate prices"
            VALIDATION_PASSED=false
          fi
          
          # Test 4: Item Count Validation - CRITICAL: Verify count matches Zoho items with stock exactly
          echo ""
          echo "[4/5] Testing Item Count vs Zoho Items with Stock (CRITICAL VALIDATION)..."
          if [ "$PRODUCTS_RESPONSE" != "FAILED" ] && [ -n "$PRODUCT_COUNT" ]; then
            # Get Zoho items count with stock (requires Zoho API access)
            if [ -n "${{ secrets.ZOHO_ORG_ID }}" ] && [ -n "${{ secrets.ZOHO_ACCESS_TOKEN }}" ]; then
              echo "Fetching Zoho items count with stock..."
              ZOHO_RESPONSE=$(curl -s -H "Authorization: Zoho-oauthtoken ${{ secrets.ZOHO_ACCESS_TOKEN }}" \
                "https://www.zohoapis.com/books/v3/items?organization_id=${{ secrets.ZOHO_ORG_ID }}&per_page=200" || echo "FAILED")
              
              if [ "$ZOHO_RESPONSE" != "FAILED" ]; then
                # Count Zoho items with stock > 0 and is_active = true (using Python for accurate parsing)
                COUNT_RESULT=$(echo "$ZOHO_RESPONSE" | python3 << 'PYTHON_SCRIPT'
import sys, json
try:
    data = json.load(sys.stdin)
    items = data.get('items', [])
    # Count items with stock > 0 and is_active = true
    count = sum(1 for item in items if item.get('stock_on_hand', 0) > 0 and item.get('is_active', True))
    print(f"SUCCESS|{count}")
except Exception as e:
    print(f"ERROR|{str(e)}")
PYTHON_SCRIPT
)
                
                if echo "$COUNT_RESULT" | grep -q "SUCCESS"; then
                  ZOHO_COUNT=$(echo "$COUNT_RESULT" | cut -d'|' -f2)
                  
                  echo "‚úÖ Zoho items with stock: $ZOHO_COUNT"
                  echo "‚úÖ TSH ERP products displayed: $PRODUCT_COUNT"
                  
                  # Calculate difference
                  DIFF=$((PRODUCT_COUNT - ZOHO_COUNT))
                  ABS_DIFF=${DIFF#-}  # Absolute value
                  
                  # CRITICAL: Allow maximum 2% variance (strict validation)
                  if [ "$ZOHO_COUNT" -gt 0 ]; then
                    PERCENT_DIFF=$((ABS_DIFF * 100 / ZOHO_COUNT))
                  else
                    PERCENT_DIFF=100
                  fi
                  
                  if [ "$PERCENT_DIFF" -le 2 ]; then
                    echo "‚úÖ Item count matches Zoho (difference: $DIFF, $PERCENT_DIFF%)"
                  else
                    echo "‚ùå CRITICAL: Item count mismatch exceeds 2% threshold"
                    echo "   Expected: $ZOHO_COUNT items (Zoho items with stock)"
                    echo "   Found: $PRODUCT_COUNT items (TSH ERP displayed)"
                    echo "   Difference: $DIFF items ($PERCENT_DIFF%)"
                    echo ""
                    echo "   Possible causes:"
                    echo "   - Products not synced from Zoho"
                    echo "   - Stock filtering not matching Zoho stock levels"
                    echo "   - Products missing Consumer pricelist prices"
                    VALIDATION_PASSED=false
                  fi
                else
                  echo "‚ùå CRITICAL: Could not determine Zoho items count with stock"
                  echo "   Error: $(echo "$COUNT_RESULT" | cut -d'|' -f2)"
                  VALIDATION_PASSED=false
                fi
              else
                echo "‚ùå CRITICAL: Could not fetch Zoho items (API unavailable)"
                echo "   This validation is required - deployment will fail"
                VALIDATION_PASSED=false
              fi
            else
              echo "‚ùå CRITICAL: Zoho credentials not configured"
              echo "   This validation is required - configure ZOHO_ORG_ID and ZOHO_ACCESS_TOKEN secrets"
              VALIDATION_PASSED=false
            fi
          else
            echo "‚ùå CRITICAL: Products endpoint failed - cannot validate item count"
            VALIDATION_PASSED=false
          fi
          
          # Test 5: API Health Check
          echo ""
          echo "[5/5] Testing API Health..."
          HEALTH_RESPONSE=$(curl -s -f "${STAGING_API_URL}/health" || echo "FAILED")
          if [ "$HEALTH_RESPONSE" = "FAILED" ]; then
            echo "‚ùå Health endpoint failed"
            VALIDATION_PASSED=false
          else
            echo "‚úÖ API health check passed"
          fi
          
          echo ""
          echo "========================================"
          if [ "$VALIDATION_PASSED" = true ]; then
            echo "‚úÖ Flutter Consumer App Validation PASSED"
            echo "========================================"
            echo "‚úÖ All products are available"
            echo "‚úÖ All product images are displayed"
            echo "‚úÖ Consumer price list (IQD) is displayed for all products"
            echo "‚úÖ Item count matches Zoho items with stock"
            echo "‚úÖ API is healthy"
          else
            echo "‚ùå Flutter Consumer App Validation FAILED"
            echo "========================================"
            echo "Please review the validation output above"
            echo ""
            echo "Required checks (ALL MUST PASS):"
            echo "  ‚ùå Products endpoint must return products"
            echo "  ‚ùå All products must have images displayed (95% threshold)"
            echo "  ‚ùå All products must display Consumer pricelist prices (IQD) - NO ZERO PRICES ALLOWED"
            echo "  ‚ùå Item count must match Zoho items with stock (max 2% variance)"
            echo ""
            echo "CRITICAL ISSUES DETECTED:"
            echo "  1. Consumer pricelist prices are showing as 0 or null"
            echo "  2. Item count does not match Zoho items with stock"
            echo ""
            echo "These issues MUST be fixed before deployment can proceed."
            exit 1
          fi
          echo "========================================"

      - name: üìä Generate Validation Report
        if: always()
        run: |
          echo "üìä Validation Report Generated"
          echo "Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        continue-on-error: true

  # ============================================================================
  # STAGE 6: DATA CONSISTENCY CHECK (Zoho ‚Üî TSH ERP)
  # ============================================================================
  data-consistency-check:
    name: üîÑ Data Consistency Check
    runs-on: ubuntu-latest
    needs: [validate-flutter-app]
    if: |
      always() &&
      needs.validate-flutter-app.result == 'success'
    timeout-minutes: 5

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: üì¶ Install dependencies
        run: |
          pip install requests psycopg2-binary

      - name: üîÑ Check Zoho ‚Üî TSH ERP Data Consistency
        env:
          STAGING_DB_URL: ${{ secrets.STAGING_DB_URL }}
          ZOHO_ORG_ID: ${{ secrets.ZOHO_ORG_ID }}
          ZOHO_ACCESS_TOKEN: ${{ secrets.ZOHO_ACCESS_TOKEN }}
        run: |
          echo "========================================"
          echo "üîÑ Checking Data Consistency..."
          echo "========================================"
          
          if [ -z "$STAGING_DB_URL" ] || [ -z "$ZOHO_ORG_ID" ] || [ -z "$ZOHO_ACCESS_TOKEN" ]; then
            echo "‚ö†Ô∏è Skipping data consistency check - secrets not configured"
            exit 0
          fi
          
          python3 << 'PYTHON_SCRIPT'
          import os
          import requests
          import psycopg2
          
          ZOHO_ORG_ID = os.getenv('ZOHO_ORG_ID')
          ZOHO_TOKEN = os.getenv('ZOHO_ACCESS_TOKEN')
          DB_URL = os.getenv('STAGING_DB_URL')
          
          print("Checking Zoho ‚Üî TSH ERP data consistency...")
          
          # Check products count
          try:
              headers = {"Authorization": f"Zoho-oauthtoken {ZOHO_TOKEN}"}
              zoho_response = requests.get(
                  f"https://www.zohoapis.com/books/v3/items?organization_id={ZOHO_ORG_ID}",
                  headers=headers,
                  timeout=10
              )
              
              if zoho_response.status_code == 200:
                  zoho_count = len(zoho_response.json().get('items', []))
                  print(f"‚úÖ Zoho Items: {zoho_count}")
                  
                  # Check ERP count
                  conn = psycopg2.connect(DB_URL)
                  cur = conn.cursor()
                  cur.execute("SELECT COUNT(*) FROM products WHERE is_active = true;")
                  erp_count = cur.fetchone()[0]
                  print(f"‚úÖ TSH ERP Products: {erp_count}")
                  
                  diff = abs(zoho_count - erp_count)
                  diff_pct = (diff / max(zoho_count, erp_count) * 100) if max(zoho_count, erp_count) > 0 else 0
                  
                  if diff_pct > 10:
                      print(f"‚ö†Ô∏è Warning: Difference of {diff} records ({diff_pct:.1f}%)")
                  else:
                      print(f"‚úÖ Acceptable difference: {diff} records ({diff_pct:.1f}%)")
                  
                  cur.close()
                  conn.close()
              else:
                  print(f"‚ö†Ô∏è Zoho API Error: {zoho_response.status_code}")
          except Exception as e:
              print(f"‚ö†Ô∏è Data consistency check error: {e}")
          
          print("========================================")
          PYTHON_SCRIPT
        continue-on-error: true

  # ============================================================================
  # FINAL SUMMARY & PRODUCTION TRIGGER
  # ============================================================================
  deployment-summary:
    name: üìä Deployment Summary
    runs-on: ubuntu-latest
    needs: [code-quality, database-validation, validate-consumer-pricelist, run-tests, validate-flutter-app, data-consistency-check]
    if: always()
    timeout-minutes: 2

    steps:
      - name: üìä Generate Deployment Summary
        run: |
          echo "========================================"
          echo "üìä STAGING DEPLOYMENT SUMMARY"
          echo "========================================"
          echo ""
          echo "Code Quality: ${{ needs.code-quality.result }}"
          echo "Database Validation: ${{ needs.database-validation.result }}"
          echo "Consumer Price List Validation: ${{ needs.validate-consumer-pricelist.result }}"
          echo "Tests: ${{ needs.run-tests.result }}"
          echo "Flutter App Validation: ${{ needs.validate-flutter-app.result }}"
          echo "Data Consistency: ${{ needs.data-consistency-check.result }}"
          echo ""
          
          if [ "${{ needs.code-quality.result }}" = "success" ] && \
             [ "${{ needs.database-validation.result }}" = "success" ] && \
             [ "${{ needs.validate-consumer-pricelist.result }}" = "success" ] && \
             [ "${{ needs.run-tests.result }}" = "success" ] && \
             [ "${{ needs.validate-flutter-app.result }}" = "success" ]; then
            echo "‚úÖ STAGING DEPLOYMENT SUCCESSFUL"
            echo ""
            echo "‚úÖ All tests passed"
            echo "‚úÖ Staging deployment completed"
            echo "‚úÖ Consumer price list validated"
            echo "‚úÖ Flutter consumer app validated"
            echo "‚úÖ Products, images, and price lists verified"
            echo ""
            echo "üöÄ Triggering production deployment..."
            echo "   Production deployment will start automatically"
            echo "   Workflow: Intelligent Production Deployment"
          else
            echo "‚ùå STAGING DEPLOYMENT FAILED"
            echo ""
            echo "Please review the failed stages above"
            echo "Production deployment will NOT be triggered"
            exit 1
          fi
          echo "========================================"

      - name: üîÄ Create PR to Main Branch
        id: create-pr
        if: |
          needs.code-quality.result == 'success' &&
          needs.database-validation.result == 'success' &&
          needs.validate-consumer-pricelist.result == 'success' &&
          needs.run-tests.result == 'success' &&
          needs.validate-flutter-app.result == 'success' &&
          (github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/staging')
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: auto-merge-to-main-${{ github.run_number }}
          base: main
          title: "üöÄ Auto-merge: Staging tests passed - Ready for production"
          body: |
            ## Automatic Merge to Main
            
            This PR was automatically created because staging tests passed successfully.
            
            **Staging Workflow Run:** ${{ github.run_id }}
            **Commit:** ${{ github.sha }}
            **Branch:** ${{ github.ref_name }}
            
            ### Validation Results
            - ‚úÖ Code Quality: Passed
            - ‚úÖ Database Validation: Passed
            - ‚úÖ Consumer Price List Validation: Passed
            - ‚úÖ Tests: Passed
            - ‚úÖ Flutter App Validation: Passed
            
            ### Next Steps
            After this PR is merged to main, the production deployment workflow will automatically trigger.
            
            **Note:** This is an automatic PR. Please review the changes before merging.
          delete-branch: true
          commit-message: "chore: auto-merge from ${{ github.ref_name }} - staging tests passed"
          labels: |
            automated
            staging-approved
            ready-for-production

      - name: ‚úÖ Auto-Merge PR to Main (Optional)
        if: |
          steps.create-pr.outputs.pull-request-number != '' &&
          env.ENABLE_AUTO_MERGE == 'true'
        uses: peter-evans/enable-pull-request-automerge@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ steps.create-pr.outputs.pull-request-number }}
          merge-method: merge

      - name: üöÄ Trigger Production Deployment
        if: |
          needs.code-quality.result == 'success' &&
          needs.database-validation.result == 'success' &&
          needs.validate-consumer-pricelist.result == 'success' &&
          needs.run-tests.result == 'success' &&
          needs.validate-flutter-app.result == 'success'
        run: |
          echo "üöÄ Staging tests passed - production deployment will be triggered automatically"
          echo ""
          echo "Steps:"
          echo "1. ‚úÖ Staging tests passed"
          echo "2. üîÄ PR created to merge to main (if on develop/staging branch)"
          echo "3. ‚è≥ After PR is merged to main, production deployment will trigger automatically"
          echo ""
          echo "The 'Intelligent Production Deployment' workflow will run automatically"
          echo "when this staging workflow completes successfully AND code is merged to main."
          echo ""
          echo "Monitor workflows here:"
          echo "https://github.com/${{ github.repository }}/actions"

