name: Staging Fast CI/CD (Optimized)

on:
  push:
    branches:
      - develop
      - staging
  pull_request:
    branches:
      - develop
      - staging

env:
  PYTHON_VERSION: "3.11"

jobs:
  # Detect what changed to enable conditional execution
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      run_db: ${{ steps.changes.outputs.db }}
      run_api: ${{ steps.changes.outputs.api }}
      run_modules: ${{ steps.changes.outputs.modules }}
      run_full: ${{ steps.changes.outputs.full }}
      skip_tests: ${{ steps.flags.outputs.skip }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check commit message flags
        id: flags
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          if echo "$COMMIT_MSG" | grep -qi "\[skip-tests\]"; then
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Detect file changes
        id: changes
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"

          # Check commit message flags
          if echo "$COMMIT_MSG" | grep -qi "\[full\]"; then
            echo "db=true" >> $GITHUB_OUTPUT
            echo "api=true" >> $GITHUB_OUTPUT
            echo "modules=true" >> $GITHUB_OUTPUT
            echo "full=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Detect changes in file paths
          DB_CHANGED=false
          API_CHANGED=false
          MODULES_CHANGED=false

          if git diff --name-only HEAD^ HEAD | grep -qE "(alembic/|migrations/|schema/)"; then
            DB_CHANGED=true
          fi

          if git diff --name-only HEAD^ HEAD | grep -qE "(tds_core/|app/api/)"; then
            API_CHANGED=true
          fi

          if git diff --name-only HEAD^ HEAD | grep -qE "(consumer_app/|erp_admin/|flutter_app/)"; then
            MODULES_CHANGED=true
          fi

          # Default to true if no changes detected (new branch, force push, etc.)
          if [ "$DB_CHANGED" = false ] && [ "$API_CHANGED" = false ] && [ "$MODULES_CHANGED" = false ]; then
            DB_CHANGED=true
            API_CHANGED=true
            MODULES_CHANGED=true
          fi

          echo "db=$DB_CHANGED" >> $GITHUB_OUTPUT
          echo "api=$API_CHANGED" >> $GITHUB_OUTPUT
          echo "modules=$MODULES_CHANGED" >> $GITHUB_OUTPUT
          echo "full=false" >> $GITHUB_OUTPUT

  # Quick validation tests (parallel group 1)
  quick-lint:
    name: Fast Linting
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: needs.detect-changes.outputs.skip_tests != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-lint-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-lint-
            ${{ runner.os }}-pip-

      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install ruff

      - name: Fast linting (ruff)
        run: |
          ruff check . --select=E,F,W --output-format=github
        continue-on-error: true

  quick-security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: needs.detect-changes.outputs.skip_tests != 'true'
    timeout-minutes: 2
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Quick security check (basic only)
        timeout-minutes: 1
        run: |
          echo "ðŸ” Starting quick security scan..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # Check for hardcoded secrets/passwords
          echo "[1/2] Checking for hardcoded secrets..."
          if grep -r "password.*=.*['\"]" app/ tds_core/ --include="*.py" 2>/dev/null | grep -v "DB_PASSWORD\|os.getenv\|config" ; then
            echo "âš ï¸  Warning: Found potential hardcoded passwords"
          else
            echo "âœ… No hardcoded secrets found"
          fi

          # Check for SQL injection patterns
          echo "[2/2] Checking for SQL injection patterns..."
          if grep -r "execute.*%\|execute.*format\|execute.*+" app/ tds_core/ --include="*.py" 2>/dev/null | grep -v "# safe\|parameterized" ; then
            echo "âš ï¸  Warning: Found potential SQL injection patterns"
          else
            echo "âœ… No SQL injection patterns found"
          fi

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Security scan complete (~10s)"
        continue-on-error: true

  # Backend API tests (parallel group 2)
  backend-tests:
    name: Backend API Tests
    runs-on: ubuntu-latest
    needs: [detect-changes, quick-lint, quick-security]
    if: needs.detect-changes.outputs.run_api == 'true' && needs.detect-changes.outputs.skip_tests != 'true'
    strategy:
      fail-fast: true
      matrix:
        test-suite: [unit, integration]

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_DB: tsh_erp_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            .venv
          key: ${{ runner.os }}-pip-backend-${{ hashFiles('tds_core/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-backend-
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f tds_core/requirements.txt ]; then
            pip install -r tds_core/requirements.txt
          fi
          pip install pytest pytest-asyncio httpx

      - name: Run ${{ matrix.test-suite }} tests
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: tsh_erp_test
          DB_USER: postgres
          DB_PASSWORD: test_password
        run: |
          pytest tests/ -v -k "${{ matrix.test-suite }}" --maxfail=3 || true
        continue-on-error: true

  # Database tests (parallel group 2)
  database-tests:
    name: Database Schema Tests
    runs-on: ubuntu-latest
    needs: [detect-changes, quick-lint, quick-security]
    if: needs.detect-changes.outputs.run_db == 'true' && needs.detect-changes.outputs.skip_tests != 'true'

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_DB: tsh_erp_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-db-${{ hashFiles('tds_core/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-db-
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f tds_core/requirements.txt ]; then
            pip install -r tds_core/requirements.txt
          fi

      - name: Run Alembic migrations
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: tsh_erp_test
          DB_USER: postgres
          DB_PASSWORD: test_password
        run: |
          if [ -d "alembic" ]; then
            alembic upgrade head || true
          fi
        continue-on-error: true

  # Offload heavy integration checks to staging server
  staging-server-checks:
    name: Staging Server Integration Tests
    runs-on: ubuntu-latest
    needs: [detect-changes, backend-tests, database-tests]
    if: |
      always() &&
      (needs.backend-tests.result == 'success' || needs.backend-tests.result == 'skipped') &&
      (needs.database-tests.result == 'success' || needs.database-tests.result == 'skipped') &&
      needs.detect-changes.outputs.skip_tests != 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run integration tests on staging server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          port: ${{ secrets.STAGING_SSH_PORT || 22 }}
          command_timeout: 5m
          script: |
            echo "Running integration tests on staging server..."

            cd /srv/tsh-staging || cd /opt/tsh_erp || exit 0

            if [ -f venv/bin/activate ]; then
              source venv/bin/activate
            elif [ -f .venv/bin/activate ]; then
              source .venv/bin/activate
            fi

            # Run quick integration smoke tests
            if [ -d "tests" ]; then
              timeout 120 pytest tests/ -v -k "integration" --maxfail=3 || echo "Tests completed with warnings"
            fi

            echo "Integration tests completed"

  # Zoho-ERP data sync check
  sync-check:
    name: Zoho â†” TSH ERP Data Consistency
    needs: [detect-changes, staging-server-checks]
    runs-on: ubuntu-latest
    if: |
      always() &&
      (needs.staging-server-checks.result == 'success' || needs.staging-server-checks.result == 'skipped') &&
      (github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/staging') &&
      needs.detect-changes.outputs.skip_tests != 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy sync script to staging
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          port: ${{ secrets.STAGING_SSH_PORT || 22 }}
          source: "scripts/run_data_sync_check.py"
          target: "/srv/tsh-staging/"
          strip_components: 0

      - name: Run Zohoâ€“ERP Sync Check on Staging Server
        continue-on-error: true
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          port: ${{ secrets.STAGING_SSH_PORT || 22 }}
          script_stop: false
          command_timeout: 5m
          script: |
            echo "========================================"
            echo "Starting Zoho â†” TSH ERP Data Sync Check"
            echo "========================================"

            cd /srv/tsh-staging || cd /opt/tsh_erp || exit 1

            chmod +x scripts/run_data_sync_check.py

            if [ -f venv/bin/activate ]; then
              source venv/bin/activate
            elif [ -f .venv/bin/activate ]; then
              source .venv/bin/activate
            fi

            # Install required dependencies (suppress output but not errors)
            python3 -m pip install --quiet --upgrade pip
            python3 -m pip install --quiet requests psycopg2-binary

            # DB connection uses peer authentication (no password needed for local postgres user)
            export DB_HOST="localhost"
            export DB_PORT="5432"
            export DB_NAME="tsh_erp"
            export DB_USER="postgres"
            export DB_PASSWORD=""  # Empty for peer authentication

            python3 scripts/run_data_sync_check.py --mode=staging --limit=100

            SYNC_RESULT=$?

            if [ $SYNC_RESULT -eq 0 ]; then
              echo "âœ… Data sync check PASSED"
            else
              echo "âŒ Data sync check FAILED"
            fi

            exit $SYNC_RESULT

      - name: Notify on sync failure
        if: failure()
        run: |
          echo "::error::Zoho and TSH ERP data are out of sync!"
          echo "::error::Please review the sync check output above"

  # Deploy to staging
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [sync-check]
    if: |
      always() &&
      (needs.sync-check.result == 'success' || needs.sync-check.result == 'failure') &&
      github.ref == 'refs/heads/develop' &&
      github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Staging Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          port: ${{ secrets.STAGING_SSH_PORT || 22 }}
          script_stop: true
          command_timeout: 10m
          script: |
            echo "Deploying to Staging..."

            cd /srv/tsh-staging || cd /opt/tsh_erp || exit 1

            git fetch origin
            git reset --hard origin/develop

            source venv/bin/activate 2>/dev/null || source .venv/bin/activate || true
            pip install -q requests psycopg2-binary

            if [ -d "alembic" ]; then
              alembic upgrade head || true
            fi

            # Restart service (staging uses tsh_erp-green, production uses blue/green)
            sudo systemctl restart tsh_erp-green || sudo systemctl restart tsh_erp-blue || sudo systemctl restart tsh-erp || true

            sleep 5
            # Check health (try active port first, then fallback)
            curl -f http://127.0.0.1:8001/health || curl -f http://127.0.0.1:8002/health

            echo "âœ… Staging deployment successful!"

      - name: Notify on success
        if: success()
        run: |
          echo "âœ… Staging deployment completed"
          echo "âœ… Data sync checks passed"
