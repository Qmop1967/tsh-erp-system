name: üéØ Production Deployment

# Production deployment workflow - deploys directly to production server
# Triggers only on push to main branch

# DEPLOYMENT FLOW:
# 1. Push to main ‚Üí This workflow runs
# 2. All validations pass ‚Üí Deploy to production
# 3. Post-deployment monitoring ‚Üí Complete

on:
  # Trigger on push to main branch only
  push:
    branches:
      - main
  
  # PR to main (validation only, does not deploy)
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
  
  # Allow manual triggering for testing
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.11"
  FLUTTER_VERSION: "3.35.5"

jobs:
  # ============================================================================
  # STAGE 1: CODE QUALITY & SECURITY CHECKS
  # ============================================================================
  code-quality:
    name: üìã Code Quality & Security
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy black bandit safety
          pip install -r requirements.txt || true

      - name: üîç Python Linting (ruff)
        run: |
          echo "üîç Checking Python code style..."
          ruff check . --output-format=github || echo "‚ö†Ô∏è Linting issues found"
        continue-on-error: true

      - name: üîí Type Checking (mypy)
        run: |
          echo "üîí Checking type annotations..."
          mypy app/ --ignore-missing-imports --no-strict-optional || echo "‚ö†Ô∏è Type issues found"
        continue-on-error: true

      - name: ‚ö´ Code Formatting Check (black)
        run: |
          echo "‚ö´ Checking code formatting..."
          black --check app/ || echo "‚ö†Ô∏è Formatting issues found"
        continue-on-error: true

      - name: üîê Security Scan (bandit)
        run: |
          echo "üîê Scanning for security vulnerabilities..."
          bandit -r app/ -f json -o bandit-report.json || true
          bandit -r app/ -f screen || echo "‚ö†Ô∏è Security issues found"
        continue-on-error: true

      - name: üìä Dependency Vulnerability Check
        run: |
          echo "üìä Checking dependencies for known vulnerabilities..."
          safety check --file=requirements.txt --output=text || echo "‚ö†Ô∏è Vulnerable dependencies found"
        continue-on-error: true

      - name: üì§ Upload Security Reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: bandit-report.json
          retention-days: 30

      - name: üö´ Check for Debug Code
        run: |
          echo "üö´ Scanning for debug code..."
          if grep -r "console.log\|print(" app/ backend/ tds_core/ 2>/dev/null | grep -v "# print\|#print" | head -5; then
            echo "‚ö†Ô∏è Warning: Debug statements found"
            echo "Please remove debug code before production deployment"
          else
            echo "‚úÖ No debug code detected"
          fi

      - name: üìù Verify Commit Signatures
        run: |
          echo "üìù Checking commit signatures..."
          git log --show-signature -1 || echo "‚ö†Ô∏è Commit not signed (consider using signed commits)"

  # ============================================================================
  # STAGE 2: DATABASE MIGRATIONS VALIDATION
  # ============================================================================
  database-validation:
    name: üóÑÔ∏è Database Schema Validation
    runs-on: ubuntu-latest
    needs: code-quality
    timeout-minutes: 5

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: tsh_erp_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: üì¶ Install dependencies
        run: |
          pip install -r requirements.txt || true
          pip install alembic psycopg2-binary sqlalchemy

      - name: üîç Check Migration Status
        run: |
          echo "üîç Checking database migrations..."
          if [ -d "migrations" ] || [ -d "app/alembic" ]; then
            export DATABASE_URL="postgresql://postgres:postgres@localhost:5432/tsh_erp_test"
            if [ -d "migrations" ]; then
              echo "‚úÖ Migrations directory found"
            fi
            if [ -d "app/alembic" ]; then
              cd app
              alembic current || echo "‚ö†Ô∏è No current migration"
              alembic upgrade head --sql > migration_preview.sql || true
              echo "‚úÖ Migrations are ready"
            fi
          else
            echo "‚ö†Ô∏è No alembic/migrations directory found"
          fi
        continue-on-error: true

  # ============================================================================
  # STAGE 2.5: CONSUMER PRICE LIST VALIDATION (CRITICAL)
  # ============================================================================
  validate-consumer-pricelist:
    name: üí∞ Consumer Price List Validation
    runs-on: ubuntu-latest
    needs: [code-quality, database-validation]
    timeout-minutes: 10

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: tsh_erp_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: üì¶ Install dependencies
        run: |
          pip install -r requirements.txt || true
          pip install psycopg2-binary sqlalchemy

      - name: üîç Pre-Flight: Check Required Secrets
        id: check_secrets
        run: |
          echo "üîç Checking required secrets and configuration..."
          
          MISSING_SECRETS=()
          
          # Check for production database URL (required for validation)
          if [ -z "${{ secrets.PROD_DB_URL }}" ]; then
            echo "‚ö†Ô∏è PROD_DB_URL secret not configured"
            echo "   Will attempt to use test database (may fail if not configured)"
            echo "skip_validation=false" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ PROD_DB_URL secret configured"
            echo "skip_validation=false" >> $GITHUB_OUTPUT
          fi
          
          echo ""
          echo "‚úÖ Pre-flight checks completed"

      - name: üí∞ Validate Consumer Price List
        id: validate_pricelist
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/tsh_erp_test
          # Use production database if staging DB not available
          PROD_DB_URL: ${{ secrets.PROD_DB_URL }}
        run: |
          echo "========================================"
          echo "üí∞ Consumer Price List Validation"
          echo "========================================"
          
          # Use production database for validation
          if [ -n "$PROD_DB_URL" ]; then
            echo "‚úÖ Using production database for validation"
            export DATABASE_URL="$PROD_DB_URL"
            echo "‚úÖ Database URL configured from PROD_DB_URL secret"
          else
            echo "‚ÑπÔ∏è Using test database (localhost:5432/tsh_erp_test)"
            echo "‚ö†Ô∏è If validation fails, configure PROD_DB_URL secret for production database access"
          fi
          
          echo ""
          echo "Running validation script..."
          echo ""
          
          # Run validation script with better error handling
          if python3 scripts/validate_consumer_pricelist.py; then
            echo ""
            echo "‚úÖ Consumer Price List validation PASSED"
            echo "========================================"
            echo "validation_passed=true" >> $GITHUB_OUTPUT
          else
            EXIT_CODE=$?
            echo ""
            echo "‚ùå CRITICAL: Consumer Price List validation FAILED"
            echo "   Exit code: $EXIT_CODE"
            echo ""
            echo "This means some products with stock are missing Consumer price list prices."
            echo "The Consumer app will NOT display these products correctly."
            echo ""
            echo "Possible causes:"
            echo "  1. Database connection failed (check DATABASE_URL)"
            echo "  2. Products missing Consumer price list prices"
            echo "  3. Consumer price list not synced from Zoho"
            echo ""
            echo "Required actions:"
            echo "1. Check database connection and credentials"
            echo "2. Sync Consumer price list from Zoho"
            echo "3. Ensure all products have Consumer price list prices"
            echo "4. Re-run validation"
            echo ""
            echo "========================================"
            echo "validation_passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi

  # ============================================================================
  # STAGE 3: UNIT & INTEGRATION TESTS
  # ============================================================================
  run-tests:
    name: üß™ Run Automated Tests
    runs-on: ubuntu-latest
    needs: [code-quality, database-validation, validate-consumer-pricelist]
    timeout-minutes: 15

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: tsh_erp_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: üì¶ Install dependencies
        run: |
          pip install -r requirements.txt || true
          pip install pytest pytest-asyncio httpx pytest-cov

      - name: üß™ Run Unit Tests
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/tsh_erp_test
        run: |
          echo "üß™ Running unit tests..."
          pytest tests/ -v --tb=short -k "unit" || echo "‚ö†Ô∏è Some unit tests failed"
        continue-on-error: true

      - name: üîå Run Integration Tests
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/tsh_erp_test
        run: |
          echo "üîå Running integration tests..."
          pytest tests/ -v --tb=short -k "integration" || echo "‚ö†Ô∏è Some integration tests failed"
        continue-on-error: true

      - name: üìä Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            .pytest_cache/
            htmlcov/
          retention-days: 7

  # ============================================================================
  # STAGE 4: FLUTTER CONSUMER APP VALIDATION
  # ============================================================================
  validate-flutter-app:
    name: üì± Validate Flutter Consumer App
    runs-on: ubuntu-latest
    needs: [code-quality, database-validation, run-tests]
    if: |
      always() &&
      (needs.code-quality.result == 'success' || needs.code-quality.result == 'skipped') &&
      (needs.database-validation.result == 'success' || needs.database-validation.result == 'skipped') &&
      (needs.run-tests.result == 'success' || needs.run-tests.result == 'skipped')
    timeout-minutes: 10

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: üì¶ Install dependencies
        run: |
          pip install requests httpx

      - name: üì± Validate Flutter Consumer App
        env:
          PROD_API_URL: ${{ secrets.PROD_API_URL || 'https://erp.tsh.sale' }}
        run: |
          echo "========================================"
          echo "üì± Validating Flutter Consumer App"
          echo "========================================"
          
          API_BASE="${PROD_API_URL}/api/consumer"
          VALIDATION_PASSED=true
          
          # Test 1: Products Endpoint - Check if products are returned
          echo ""
          echo "[1/4] Testing Products Endpoint..."
          PRODUCTS_RESPONSE=$(curl -s -f "${API_BASE}/products" || echo "FAILED")
          
          if [ "$PRODUCTS_RESPONSE" = "FAILED" ]; then
            echo "‚ùå Products endpoint failed or returned no data"
            VALIDATION_PASSED=false
          else
            PRODUCT_COUNT=$(echo "$PRODUCTS_RESPONSE" | grep -o '"count":[0-9]*' | grep -o '[0-9]*' | head -1)
            if [ -z "$PRODUCT_COUNT" ] || [ "$PRODUCT_COUNT" -eq 0 ]; then
              echo "‚ùå No products found in response"
              VALIDATION_PASSED=false
            else
              echo "‚úÖ Products endpoint working - Found $PRODUCT_COUNT products"
            fi
          fi
          
          # Test 2: Product Images - Check if ALL products have images displayed
          echo ""
          echo "[2/5] Testing Product Images Display..."
          if [ "$PRODUCTS_RESPONSE" != "FAILED" ]; then
            # Count products with image URLs
            IMAGE_COUNT=$(echo "$PRODUCTS_RESPONSE" | grep -o '"image_url":"[^"]*"' | wc -l || echo "0")
            PRODUCT_COUNT_WITH_IMAGES=$(echo "$PRODUCTS_RESPONSE" | python3 -c "import sys, json; data=json.load(sys.stdin); items=data.get('items', []); print(sum(1 for item in items if item.get('image_url') and item.get('image_url') != 'null' and 'placeholder' not in item.get('image_url', '').lower()))" 2>/dev/null || echo "0")
            
            if [ "$IMAGE_COUNT" -eq 0 ]; then
              echo "‚ùå No image URLs found in products"
              VALIDATION_PASSED=false
            else
              echo "‚úÖ Found $IMAGE_COUNT products with image URLs"
              
              # Verify all products have images (or at least 95% have images)
              if [ -n "$PRODUCT_COUNT" ] && [ "$PRODUCT_COUNT" -gt 0 ]; then
                IMAGE_PERCENTAGE=$((PRODUCT_COUNT_WITH_IMAGES * 100 / PRODUCT_COUNT))
                if [ "$IMAGE_PERCENTAGE" -ge 95 ]; then
                  echo "‚úÖ $IMAGE_PERCENTAGE% of products have images ($PRODUCT_COUNT_WITH_IMAGES/$PRODUCT_COUNT)"
                else
                  echo "‚ö†Ô∏è Warning: Only $IMAGE_PERCENTAGE% of products have images ($PRODUCT_COUNT_WITH_IMAGES/$PRODUCT_COUNT)"
                fi
              fi
              
              # Test if at least one image is accessible
              FIRST_IMAGE=$(echo "$PRODUCTS_RESPONSE" | grep -o '"image_url":"[^"]*"' | head -1 | cut -d'"' -f4)
              if [ -n "$FIRST_IMAGE" ] && [ "$FIRST_IMAGE" != "null" ]; then
                # Check if image URL is accessible (skip if it's a placeholder)
                if [[ "$FIRST_IMAGE" != *"placeholder"* ]]; then
                  IMAGE_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$FIRST_IMAGE" || echo "000")
                  if [ "$IMAGE_STATUS" = "200" ]; then
                    echo "‚úÖ Sample product image is accessible (HTTP $IMAGE_STATUS)"
                  else
                    echo "‚ö†Ô∏è Warning: Sample product image returned HTTP $IMAGE_STATUS"
                  fi
                fi
              fi
            fi
          else
            echo "‚ö†Ô∏è Skipping image check - products endpoint failed"
            VALIDATION_PASSED=false
          fi
          
          # Test 3: Consumer Price List - CRITICAL: Verify ALL products display Consumer pricelist with price > 0
          # This test ensures the root cause fix is working (no base price fallback)
          echo ""
          echo "[3/5] Testing Consumer Price List Display (CRITICAL VALIDATION)..."
          echo "   Validating: Products MUST have Consumer price list prices (no base price fallback)"
          if [ "$PRODUCTS_RESPONSE" != "FAILED" ]; then
            # Use Python to properly parse JSON and validate prices
            PRICE_VALIDATION=$(echo "$PRODUCTS_RESPONSE" | python3 << 'PYTHON_SCRIPT'
import sys, json
try:
    data = json.load(sys.stdin)
    items = data.get('items', [])
    
    if not items:
        print("ERROR:NO_ITEMS")
        sys.exit(1)
    
    total_items = len(items)
    items_with_price = 0
    items_with_zero_price = 0
    items_with_null_price = 0
    items_with_iqd = 0
    items_with_base_price = 0  # Track if any products show base price (should be 0)
    
    for item in items:
        price = item.get('price')
        currency = item.get('currency', '')
        
        # Check if price looks like base price (very low prices might indicate base price)
        # This is a heuristic - Consumer prices should be reasonable
        if price is not None and price > 0 and price < 0.01:
            items_with_base_price += 1
        
        if price is None:
            items_with_null_price += 1
        elif price == 0 or price == 0.0:
            items_with_zero_price += 1
        elif price > 0:
            items_with_price += 1
        
        if currency == 'IQD':
            items_with_iqd += 1
    
    # CRITICAL: Fail if ANY product has zero or null price
    if items_with_zero_price > 0 or items_with_null_price > 0:
        print(f"ERROR:ZERO_PRICES|total={total_items}|with_price={items_with_price}|zero_price={items_with_zero_price}|null_price={items_with_null_price}|iqd={items_with_iqd}")
        sys.exit(1)
    
    # CRITICAL: Fail if not all products have IQD currency
    if items_with_iqd != total_items:
        print(f"ERROR:WRONG_CURRENCY|total={total_items}|iqd={items_with_iqd}")
        sys.exit(1)
    
    # WARNING: If many products have very low prices, might be base prices
    if items_with_base_price > total_items * 0.1:  # More than 10% have suspiciously low prices
        print(f"WARNING:SUSPICIOUS_PRICES|total={total_items}|suspicious={items_with_base_price}")
    
    print(f"SUCCESS|total={total_items}|with_price={items_with_price}|iqd={items_with_iqd}")
except Exception as e:
    print(f"ERROR:PARSE_ERROR|{str(e)}")
    sys.exit(1)
PYTHON_SCRIPT
)
            
            if echo "$PRICE_VALIDATION" | grep -q "ERROR:"; then
              echo "‚ùå CRITICAL: Consumer Price List validation FAILED"
              echo "$PRICE_VALIDATION"
              echo ""
              echo "Issues found:"
              if echo "$PRICE_VALIDATION" | grep -q "ZERO_PRICES"; then
                echo "  ‚ùå Products with zero or null prices detected"
                echo "  ‚ùå Consumer pricelist is not being applied correctly"
              fi
              if echo "$PRICE_VALIDATION" | grep -q "WRONG_CURRENCY"; then
                echo "  ‚ùå Not all products have IQD currency"
              fi
              VALIDATION_PASSED=false
            else
              echo "‚úÖ Consumer Price List validation PASSED"
              echo "$PRICE_VALIDATION"
            fi
          else
            echo "‚ùå CRITICAL: Products endpoint failed - cannot validate prices"
            VALIDATION_PASSED=false
          fi
          
          # Test 4: Item Count Validation - CRITICAL: Verify count matches Zoho items with stock exactly
          echo ""
          echo "[4/5] Testing Item Count vs Zoho Items with Stock (CRITICAL VALIDATION)..."
          if [ "$PRODUCTS_RESPONSE" != "FAILED" ] && [ -n "$PRODUCT_COUNT" ]; then
            # Get Zoho items count with stock (requires Zoho API access)
            if [ -n "${{ secrets.ZOHO_ORG_ID }}" ] && [ -n "${{ secrets.ZOHO_ACCESS_TOKEN }}" ]; then
              echo "Fetching Zoho items count with stock..."
              ZOHO_RESPONSE=$(curl -s -H "Authorization: Zoho-oauthtoken ${{ secrets.ZOHO_ACCESS_TOKEN }}" \
                "https://www.zohoapis.com/books/v3/items?organization_id=${{ secrets.ZOHO_ORG_ID }}&per_page=200" || echo "FAILED")
              
              if [ "$ZOHO_RESPONSE" != "FAILED" ]; then
                # Count Zoho items with stock > 0 and is_active = true (using Python for accurate parsing)
                COUNT_RESULT=$(echo "$ZOHO_RESPONSE" | python3 << 'PYTHON_SCRIPT'
import sys, json
try:
    data = json.load(sys.stdin)
    items = data.get('items', [])
    # Count items with stock > 0 and is_active = true
    count = sum(1 for item in items if item.get('stock_on_hand', 0) > 0 and item.get('is_active', True))
    print(f"SUCCESS|{count}")
except Exception as e:
    print(f"ERROR|{str(e)}")
PYTHON_SCRIPT
)
                
                if echo "$COUNT_RESULT" | grep -q "SUCCESS"; then
                  ZOHO_COUNT=$(echo "$COUNT_RESULT" | cut -d'|' -f2)
                  
                  echo "‚úÖ Zoho items with stock: $ZOHO_COUNT"
                  echo "‚úÖ TSH ERP products displayed: $PRODUCT_COUNT"
                  
                  # Calculate difference
                  DIFF=$((PRODUCT_COUNT - ZOHO_COUNT))
                  ABS_DIFF=${DIFF#-}  # Absolute value
                  
                  # CRITICAL: Allow maximum 2% variance (strict validation)
                  if [ "$ZOHO_COUNT" -gt 0 ]; then
                    PERCENT_DIFF=$((ABS_DIFF * 100 / ZOHO_COUNT))
                  else
                    PERCENT_DIFF=100
                  fi
                  
                  if [ "$PERCENT_DIFF" -le 2 ]; then
                    echo "‚úÖ Item count matches Zoho (difference: $DIFF, $PERCENT_DIFF%)"
                  else
                    echo "‚ùå CRITICAL: Item count mismatch exceeds 2% threshold"
                    echo "   Expected: $ZOHO_COUNT items (Zoho items with stock)"
                    echo "   Found: $PRODUCT_COUNT items (TSH ERP displayed)"
                    echo "   Difference: $DIFF items ($PERCENT_DIFF%)"
                    echo ""
                    echo "   Possible causes:"
                    echo "   - Products not synced from Zoho"
                    echo "   - Stock filtering not matching Zoho stock levels"
                    echo "   - Products missing Consumer pricelist prices"
                    VALIDATION_PASSED=false
                  fi
                else
                  echo "‚ùå CRITICAL: Could not determine Zoho items count with stock"
                  echo "   Error: $(echo "$COUNT_RESULT" | cut -d'|' -f2)"
                  VALIDATION_PASSED=false
                fi
              else
                echo "‚ùå CRITICAL: Could not fetch Zoho items (API unavailable)"
                echo "   This validation is required - deployment will fail"
                VALIDATION_PASSED=false
              fi
            else
              echo "‚ùå CRITICAL: Zoho credentials not configured"
              echo "   This validation is required - configure ZOHO_ORG_ID and ZOHO_ACCESS_TOKEN secrets"
              VALIDATION_PASSED=false
            fi
          else
            echo "‚ùå CRITICAL: Products endpoint failed - cannot validate item count"
            VALIDATION_PASSED=false
          fi
          
          # Test 5: API Health Check
          echo ""
          echo "[5/5] Testing API Health..."
          HEALTH_RESPONSE=$(curl -s -f "${PROD_API_URL}/health" || echo "FAILED")
          if [ "$HEALTH_RESPONSE" = "FAILED" ]; then
            echo "‚ùå Health endpoint failed"
            VALIDATION_PASSED=false
          else
            echo "‚úÖ API health check passed"
          fi
          
          echo ""
          echo "========================================"
          if [ "$VALIDATION_PASSED" = true ]; then
            echo "‚úÖ Flutter Consumer App Validation PASSED"
            echo "========================================"
            echo "‚úÖ All products are available"
            echo "‚úÖ All product images are displayed"
            echo "‚úÖ Consumer price list (IQD) is displayed for all products"
            echo "‚úÖ Item count matches Zoho items with stock"
            echo "‚úÖ API is healthy"
          else
            echo "‚ùå Flutter Consumer App Validation FAILED"
            echo "========================================"
            echo "Please review the validation output above"
            echo ""
            echo "Required checks (ALL MUST PASS):"
            echo "  ‚ùå Products endpoint must return products"
            echo "  ‚ùå All products must have images displayed (95% threshold)"
            echo "  ‚ùå All products must display Consumer pricelist prices (IQD) - NO ZERO PRICES ALLOWED"
            echo "  ‚ùå Item count must match Zoho items with stock (max 2% variance)"
            echo ""
            echo "CRITICAL ISSUES DETECTED:"
            echo "  1. Consumer pricelist prices are showing as 0 or null"
            echo "  2. Item count does not match Zoho items with stock"
            echo ""
            echo "These issues MUST be fixed before deployment can proceed."
            exit 1
          fi
          echo "========================================"

      - name: üìä Generate Validation Report
        if: always()
        run: |
          echo "üìä Validation Report Generated"
          echo "Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        continue-on-error: true

  # ============================================================================
  # STAGE 5: DATA CONSISTENCY CHECK (Zoho ‚Üî TSH ERP)
  # ============================================================================
  data-consistency-check:
    name: üîÑ Data Consistency Check
    runs-on: ubuntu-latest
    needs: [validate-flutter-app]
    if: |
      always() &&
      needs.validate-flutter-app.result == 'success'
    timeout-minutes: 5

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: üì¶ Install dependencies
        run: |
          pip install requests psycopg2-binary

      - name: üîÑ Check Zoho ‚Üî TSH ERP Data Consistency
        env:
          PROD_DB_URL: ${{ secrets.PROD_DB_URL }}
          ZOHO_ORG_ID: ${{ secrets.ZOHO_ORG_ID }}
          ZOHO_ACCESS_TOKEN: ${{ secrets.ZOHO_ACCESS_TOKEN }}
        run: |
          echo "========================================"
          echo "üîÑ Checking Data Consistency..."
          echo "========================================"
          
          if [ -z "$PROD_DB_URL" ] || [ -z "$ZOHO_ORG_ID" ] || [ -z "$ZOHO_ACCESS_TOKEN" ]; then
            echo "‚ö†Ô∏è Skipping data consistency check - secrets not configured"
            exit 0
          fi
          
          python3 << 'PYTHON_SCRIPT'
          import os
          import requests
          import psycopg2
          
          ZOHO_ORG_ID = os.getenv('ZOHO_ORG_ID')
          ZOHO_TOKEN = os.getenv('ZOHO_ACCESS_TOKEN')
          DB_URL = os.getenv('PROD_DB_URL')
          
          print("Checking Zoho ‚Üî TSH ERP data consistency...")
          
          # Check products count
          try:
              headers = {"Authorization": f"Zoho-oauthtoken {ZOHO_TOKEN}"}
              zoho_response = requests.get(
                  f"https://www.zohoapis.com/books/v3/items?organization_id={ZOHO_ORG_ID}",
                  headers=headers,
                  timeout=10
              )
              
              if zoho_response.status_code == 200:
                  zoho_count = len(zoho_response.json().get('items', []))
                  print(f"‚úÖ Zoho Items: {zoho_count}")
                  
                  # Check ERP count
                  conn = psycopg2.connect(DB_URL)
                  cur = conn.cursor()
                  cur.execute("SELECT COUNT(*) FROM products WHERE is_active = true;")
                  erp_count = cur.fetchone()[0]
                  print(f"‚úÖ TSH ERP Products: {erp_count}")
                  
                  diff = abs(zoho_count - erp_count)
                  diff_pct = (diff / max(zoho_count, erp_count) * 100) if max(zoho_count, erp_count) > 0 else 0
                  
                  if diff_pct > 10:
                      print(f"‚ö†Ô∏è Warning: Difference of {diff} records ({diff_pct:.1f}%)")
                  else:
                      print(f"‚úÖ Acceptable difference: {diff} records ({diff_pct:.1f}%)")
                  
                  cur.close()
                  conn.close()
              else:
                  print(f"‚ö†Ô∏è Zoho API Error: {zoho_response.status_code}")
          except Exception as e:
              print(f"‚ö†Ô∏è Data consistency check error: {e}")
          
          print("========================================")
          PYTHON_SCRIPT
        continue-on-error: true

  # ============================================================================
  # STAGE 2: DATABASE BACKUP & VALIDATION
  # ============================================================================
  database-backup:
    name: üíæ Database Backup & Validation
    runs-on: ubuntu-latest
    needs: [code-quality, database-validation, validate-consumer-pricelist, run-tests, validate-flutter-app]
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      github.event_name == 'workflow_dispatch'

    steps:
      - name: üíæ Create Production Database Backup
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: ${{ secrets.PROD_SSH_PORT || 22 }}
          script: |
            echo "üíæ Creating production database backup..."

            BACKUP_DIR="/opt/backups/auto"
            mkdir -p $BACKUP_DIR

            BACKUP_FILE="$BACKUP_DIR/pre_deploy_$(date +%Y%m%d_%H%M%S).sql"

            # Backup database
            PGPASSWORD="${{ secrets.DB_PASSWORD }}" pg_dump \
              -h localhost \
              -U ${{ secrets.DB_USER }} \
              -d ${{ secrets.DB_NAME }} \
              -F c \
              -f "$BACKUP_FILE"

            if [ -f "$BACKUP_FILE" ]; then
              SIZE=$(du -h "$BACKUP_FILE" | cut -f1)
              echo "‚úÖ Backup created: $BACKUP_FILE ($SIZE)"

              # Keep last 10 backups only
              ls -t $BACKUP_DIR/pre_deploy_*.sql | tail -n +11 | xargs -r rm
              echo "‚úÖ Old backups cleaned up"
            else
              echo "‚ùå Backup failed!"
              exit 1
            fi

      - name: üóÑÔ∏è Validate Production Database
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: ${{ secrets.PROD_SSH_PORT || 22 }}
          script: |
            echo "üóÑÔ∏è Validating production database..."

            PGPASSWORD="${{ secrets.DB_PASSWORD }}" psql \
              -h localhost \
              -U ${{ secrets.DB_USER }} \
              -d ${{ secrets.DB_NAME }} \
              -c "SELECT COUNT(*) as total_tables FROM information_schema.tables WHERE table_schema = 'public';"

            PGPASSWORD="${{ secrets.DB_PASSWORD }}" psql \
              -h localhost \
              -U ${{ secrets.DB_USER }} \
              -d ${{ secrets.DB_NAME }} \
              -c "SELECT
                    (SELECT COUNT(*) FROM users) as users_count,
                    (SELECT COUNT(*) FROM products) as products_count,
                    (SELECT COUNT(*) FROM customers) as customers_count;"

            echo "‚úÖ Database validation completed"

  # ============================================================================
  # STAGE 3: PRODUCTION DATA CONSISTENCY CHECK
  # ============================================================================
  production-data-check:
    name: üîÑ Production Data Consistency
    runs-on: ubuntu-latest
    needs: database-backup

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: üîÑ Verify Production Data Integrity
        run: |
          pip install psycopg2-binary requests

          python3 << 'PYTHON_SCRIPT'
          import psycopg2
          import requests
          from datetime import datetime

          print("=" * 60)
          print("üîÑ PRODUCTION DATA INTEGRITY CHECK")
          print("=" * 60)

          DB_URL = "${{ secrets.PRODUCTION_DB_URL }}"

          try:
              conn = psycopg2.connect(DB_URL)
              cur = conn.cursor()

              # Check for duplicate records
              print("\nüîç Checking for duplicate records...")

              queries = {
                  "Duplicate Customers": "SELECT email, COUNT(*) as count FROM customers GROUP BY email HAVING COUNT(*) > 1;",
                  "Duplicate Products": "SELECT sku, COUNT(*) as count FROM products WHERE sku IS NOT NULL GROUP BY sku HAVING COUNT(*) > 1;",
                  "Orphaned Records": "SELECT COUNT(*) FROM invoices WHERE customer_id NOT IN (SELECT id FROM customers);"
              }

              issues = []

              for check_name, query in queries.items():
                  cur.execute(query)
                  result = cur.fetchall()
                  if result and len(result) > 0:
                      if check_name == "Orphaned Records" and result[0][0] > 0:
                          print(f"  ‚ö†Ô∏è {check_name}: {result[0][0]} found")
                          issues.append(f"{check_name}: {result[0][0]}")
                      elif check_name != "Orphaned Records":
                          print(f"  ‚ö†Ô∏è {check_name}: {len(result)} found")
                          issues.append(f"{check_name}: {len(result)}")
                  else:
                      print(f"  ‚úÖ {check_name}: None found")

              # Check database size
              cur.execute("SELECT pg_size_pretty(pg_database_size(current_database()));")
              db_size = cur.fetchone()[0]
              print(f"\nüíæ Database Size: {db_size}")

              cur.close()
              conn.close()

              if issues:
                  print(f"\n‚ö†Ô∏è {len(issues)} data integrity issues detected")
                  print("Issues should be reviewed but deployment can continue")
              else:
                  print("\n‚úÖ All data integrity checks passed")

          except Exception as e:
              print(f"\n‚ùå Data integrity check failed: {e}")
              exit(1)
          PYTHON_SCRIPT

  # ============================================================================
  # STAGE 4: MIGRATION DRY RUN
  # ============================================================================
  migration-preview:
    name: üîÑ Migration Preview
    runs-on: ubuntu-latest
    needs: production-data-check

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: üì¶ Install dependencies
        run: |
          pip install alembic psycopg2-binary sqlalchemy

      - name: üîç Generate Migration Preview
        run: |
          echo "üîç Generating migration preview..."

          cd app || cd backend || true

          if [ -d "alembic" ]; then
            # Generate SQL preview without applying
            alembic upgrade head --sql > migration_preview.sql 2>&1 || true

            if [ -f "migration_preview.sql" ]; then
              echo "üìÑ Migration Preview:"
              echo "===================="
              cat migration_preview.sql
              echo "===================="

              # Check if there are actual migrations
              if grep -q "CREATE\|ALTER\|DROP" migration_preview.sql; then
                echo "‚ö†Ô∏è Database schema changes detected"
                echo "Migration will be applied during deployment"
              else
                echo "‚úÖ No schema changes - database is up to date"
              fi
            fi
          else
            echo "‚ÑπÔ∏è No alembic directory found"
          fi
        continue-on-error: true

  # ============================================================================
  # STAGE 5: SERVICE HEALTH CHECK
  # ============================================================================
  service-health-check:
    name: üè• Current Service Health Check
    runs-on: ubuntu-latest
    needs: migration-preview

    steps:
      - name: üè• Check Current Production Services
        if: ${{ secrets.PROD_HOST != '' && secrets.PROD_USER != '' && secrets.PROD_SSH_KEY != '' }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: ${{ secrets.PROD_SSH_PORT || 22 }}
          script: |
            echo "üè• Checking production service health..."

            echo ""
            echo "üìä Service Status:"
            systemctl status tsh-erp --no-pager -l || true
            systemctl status tsh_erp-green --no-pager -l || true

            echo ""
            echo "üîå Port Status:"
            ss -tlnp | grep -E ":(8001|8002)" || echo "No services on ports 8001/8002"

            echo ""
            echo "üíæ Resource Usage:"
            free -h
            df -h /opt/tsh_erp

            echo ""
            echo "üìù Recent Logs:"
            journalctl -u tsh-erp -n 10 --no-pager || true

            echo ""
            echo "‚úÖ Health check completed"

  # ============================================================================
  # STAGE 6: DEPLOY TO PRODUCTION (BLUE-GREEN)
  # ============================================================================
  deploy-to-production:
    name: üöÄ Deploy to Production
    runs-on: ubuntu-latest
    needs: [database-backup, production-data-check, migration-preview, service-health-check]
    outputs:
      deployment_performed: ${{ steps.check_secrets.outputs.skip != 'true' && steps.execute_deploy.outcome == 'success' }}
    if: ${{ (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: üîê Check production SSH secrets
        id: check_secrets
        run: |
          if [ -z "${{ secrets.PROD_HOST }}" ] || [ -z "${{ secrets.PROD_USER }}" ] || [ -z "${{ secrets.PROD_SSH_KEY }}" ]; then
            echo "‚ö†Ô∏è Production SSH secrets not configured. Skipping deployment stage."
            echo "Required secrets:"
            echo "  - PROD_HOST"
            echo "  - PROD_USER"
            echo "  - PROD_SSH_KEY"
            echo "skip=true" >> "$GITHUB_OUTPUT"
          else
            echo "‚úÖ Production SSH secrets detected"
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: üöÄ Execute Blue-Green Deployment
        id: execute_deploy
        if: steps.check_secrets.outputs.skip != 'true'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: ${{ secrets.PROD_SSH_PORT || 22 }}
          script_stop: true
          script: |
            set -eo pipefail

            echo "========================================"
            echo "üöÄ PRODUCTION DEPLOYMENT STARTING"
            echo "========================================"

            if [ -d "/home/deploy/TSH_ERP_Ecosystem" ]; then
              DEPLOY_DIR="/home/deploy/TSH_ERP_Ecosystem"
            elif [ -d "/opt/tsh_erp" ]; then
              DEPLOY_DIR="/opt/tsh_erp"
            else
              echo "‚ùå Deployment directory not found (/home/deploy/TSH_ERP_Ecosystem or /opt/tsh_erp)"
              exit 1
            fi

            echo "üìÇ Using deployment directory: ${DEPLOY_DIR}"
            cd "${DEPLOY_DIR}"

            echo "üì• Pulling latest code from main branch..."
            git fetch origin
            git reset --hard origin/main

            if [ -f "./deploy.sh" ]; then
              chmod +x ./deploy.sh
            fi

            RESTART_SUCCESS=0
            DEPLOYMENT_METHOD="none"

            if systemctl list-unit-files | grep -q '^tsh-erp\.service'; then
              echo "üîÑ Restarting systemd service: tsh-erp.service"
              if systemctl restart tsh-erp; then
                RESTART_SUCCESS=1
                DEPLOYMENT_METHOD="systemd (tsh-erp.service)"
              else
                echo "‚ö†Ô∏è systemctl restart tsh-erp failed"
              fi
            fi

            if [ ${RESTART_SUCCESS} -eq 0 ] && systemctl list-unit-files | grep -q '^tsh_erp\.service'; then
              echo "üîÑ Restarting systemd service: tsh_erp.service"
              if systemctl restart tsh_erp; then
                RESTART_SUCCESS=1
                DEPLOYMENT_METHOD="systemd (tsh_erp.service)"
              else
                echo "‚ö†Ô∏è systemctl restart tsh_erp failed"
              fi
            fi

            if [ ${RESTART_SUCCESS} -eq 0 ] && [ -f "docker-compose.yml" ] && command -v docker >/dev/null 2>&1; then
              if docker compose version >/dev/null 2>&1; then
                echo "üîÑ Deploying with docker compose"
                docker compose pull || true
                docker compose up -d --build
                RESTART_SUCCESS=1
                DEPLOYMENT_METHOD="docker compose"
              elif command -v docker-compose >/dev/null 2>&1; then
                echo "üîÑ Deploying with docker-compose"
                docker-compose pull || true
                docker-compose up -d --build
                RESTART_SUCCESS=1
                DEPLOYMENT_METHOD="docker-compose"
              fi
            fi

            if [ ${RESTART_SUCCESS} -eq 0 ] && [ -f "./deploy.sh" ]; then
              echo "üîÑ Falling back to ./deploy.sh update"
              ./deploy.sh update || ./deploy.sh restart || ./deploy.sh start || true
              RESTART_SUCCESS=1
              DEPLOYMENT_METHOD="deploy.sh"
            fi

            if [ ${RESTART_SUCCESS} -eq 0 ]; then
              echo "‚ö†Ô∏è Deployment commands executed but service restart could not be confirmed automatically."
            else
              echo "‚úÖ Deployment restart completed via ${DEPLOYMENT_METHOD}"
            fi

            echo "========================================"
            echo "‚úÖ DEPLOYMENT STEPS COMPLETED"
            echo "========================================"

      - name: üîç Verify Deployment
        if: steps.check_secrets.outputs.skip != 'true'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: ${{ secrets.PROD_SSH_PORT || 22 }}
          script: |
            set -eo pipefail

            echo "üîç Verifying deployment..."

            HEALTH_URLS=(
              "http://127.0.0.1:8000/health"
              "http://127.0.0.1:8001/health"
              "http://127.0.0.1:8002/health"
            )

            HEALTH_OK=0
            for url in "${HEALTH_URLS[@]}"; do
              if curl -sf "${url}" >/dev/null 2>&1; then
                echo "‚úÖ Internal health check passed (${url})"
                HEALTH_OK=1
                break
              else
                echo "‚ÑπÔ∏è Health check failed for ${url} (trying next)"
              fi
            done

            if [ ${HEALTH_OK} -eq 0 ]; then
              echo "‚ùå All internal health checks failed"
              exit 1
            fi

            if curl -sf https://erp.tsh.sale/health >/dev/null 2>&1; then
              echo "‚úÖ Public endpoint healthy (https://erp.tsh.sale/health)"
            else
              echo "‚ö†Ô∏è Public endpoint not reachable (https://erp.tsh.sale/health)"
            fi

  # ============================================================================
  # STAGE 7: POST-DEPLOYMENT MONITORING
  # ============================================================================
  post-deployment-monitoring:
    name: üìä Post-Deployment Monitoring
    runs-on: ubuntu-latest
    needs: deploy-to-production
    if: ${{ needs.deploy-to-production.outputs.deployment_performed == 'true' }}

    steps:
      - name: üìä Monitor System for 2 Minutes
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: ${{ secrets.PROD_SSH_PORT || 22 }}
          command_timeout: 150s
          script: |
            echo "üìä Monitoring system for 2 minutes..."

            for i in {1..4}; do
              echo ""
              echo "Check $i/4 ($(date))"
              echo "===================="

              # Health check
              curl -s http://127.0.0.1:8001/health || curl -s http://127.0.0.1:8002/health

              # Check for errors in logs
              ERROR_COUNT=$(journalctl -u tsh-erp --since "1 minute ago" -p err --no-pager | wc -l)
              echo "Recent errors: $ERROR_COUNT"

              if [ $ERROR_COUNT -gt 5 ]; then
                echo "‚ö†Ô∏è High error rate detected"
              fi

              # Memory and CPU
              echo "Resource usage:"
              ps aux | grep python | head -5

              sleep 30
            done

            echo "‚úÖ Monitoring completed - system appears stable"

      - name: üåê External Health Check
        run: |
          echo "üåê Performing external health checks..."

          # Test production URLs
          URLs=(
            "https://erp.tsh.sale/health"
            "https://consumer.tsh.sale"
          )

          for url in "${URLs[@]}"; do
            echo "Testing: $url"
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$url" || echo "000")

            if [ "$STATUS" = "200" ]; then
              echo "  ‚úÖ $url (HTTP $STATUS)"
            else
              echo "  ‚ö†Ô∏è $url (HTTP $STATUS)"
            fi
          done

          echo "‚úÖ External checks completed"

  # ============================================================================
  # STAGE 8: DEPLOYMENT SUCCESS NOTIFICATION
  # ============================================================================
  deployment-summary:
    name: üì¢ Deployment Summary
    runs-on: ubuntu-latest
    needs: post-deployment-monitoring
    if: success()

    steps:
      - name: üéâ Deployment Success Summary
        run: |
          echo "========================================"
          echo "üéâ PRODUCTION DEPLOYMENT SUCCESSFUL!"
          echo "========================================"
          echo ""
          echo "‚úÖ All checks passed"
          echo "‚úÖ Database backed up"
          echo "‚úÖ Blue-green deployment completed"
          echo "‚úÖ Health checks passed"
          echo "‚úÖ Post-deployment monitoring passed"
          echo ""
          echo "Production URLs:"
          echo "  ‚Ä¢ Backend API: https://erp.tsh.sale"
          echo "  ‚Ä¢ Consumer App: https://consumer.tsh.sale"
          echo ""
          echo "Deployment completed at: $(date -u)"
          echo "========================================"

  # ============================================================================
  # STAGE 9: ROLLBACK (ON FAILURE)
  # ============================================================================
  rollback-on-failure:
    name: üîÑ Automatic Rollback
    runs-on: ubuntu-latest
    needs: [deploy-to-production]
    if: ${{ needs.deploy-to-production.outputs.deployment_performed == 'true' && needs.deploy-to-production.result == 'failure' }}

    steps:
      - name: üîÑ Execute Rollback
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: ${{ secrets.PROD_SSH_PORT || 22 }}
          script: |
            echo "üîÑ Deployment failed - initiating automatic rollback..."

            # Switch back to previous deployment
            bash /opt/tsh_erp/bin/switch_deployment.sh

            sleep 5

            # Verify rollback
            curl -f http://127.0.0.1:8001/health || curl -f http://127.0.0.1:8002/health

            echo "‚úÖ Rollback completed - previous version restored"

      - name: üö® Create Rollback Issue
        uses: actions/github-script@v6
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö® Production Deployment Failed - Auto Rollback Executed',
              body: `## Deployment Failure Report

**Time:** ${new Date().toISOString()}
**Branch:** main
**Commit:** ${{ github.sha }}
**Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

### Status
‚ùå Deployment failed
‚úÖ Automatic rollback executed
‚úÖ Previous version restored

### Action Required
1. Review deployment logs
2. Fix the issue
3. Retry deployment

---
*This issue was created automatically by the production deployment workflow.*`,
              labels: ['production', 'deployment-failure', 'critical']
            });
