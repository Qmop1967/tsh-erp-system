name: GHCR Lifecycle Management - Cleanup Old Images

on:
  schedule:
    # Run every Sunday at 00:00 UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Perform dry run without actually deleting images'
        required: false
        type: boolean
        default: true
      service:
        description: 'Service to clean (app, neurolink, tds-admin, all)'
        required: false
        type: choice
        options:
          - all
          - app
          - neurolink
          - tds-admin
        default: 'all'

env:
  RETENTION_DAYS: 30  # Keep all images from last 30 days
  KEEP_LAST_N: 10     # Keep at least 10 most recent versions per service

jobs:
  cleanup-app:
    name: Cleanup TSH ERP App Images
    runs-on: ubuntu-latest
    if: github.event.inputs.service == 'all' || github.event.inputs.service == 'app' || github.event_name == 'schedule'
    permissions:
      packages: write
      contents: read

    steps:
      - name: Delete old untagged images
        uses: actions/delete-package-versions@v5
        with:
          package-name: 'tsh-erp-app'
          package-type: 'container'
          min-versions-to-keep: ${{ env.KEEP_LAST_N }}
          delete-only-untagged-versions: 'true'
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete old versions (keep last N and recent)
        uses: dataaxiom/ghcr-cleanup-action@v1
        with:
          package: tsh-erp-app
          token: ${{ secrets.GITHUB_TOKEN }}
          owner: ${{ github.repository_owner }}
          keep-n-tagged: ${{ env.KEEP_LAST_N }}
          older-than: ${{ env.RETENTION_DAYS }} days
          exclude-tags: latest,production,staging,v*.*.*
          dry-run: ${{ github.event.inputs.dry_run || 'false' }}

      - name: Report cleanup summary
        run: |
          echo "## üßπ Cleanup Summary - App Service" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Service:** tsh-erp-app" >> $GITHUB_STEP_SUMMARY
          echo "**Retention:** ${{ env.RETENTION_DAYS }} days" >> $GITHUB_STEP_SUMMARY
          echo "**Versions Kept:** Last ${{ env.KEEP_LAST_N }}" >> $GITHUB_STEP_SUMMARY
          echo "**Protected Tags:** latest, production, staging, v*.*.*" >> $GITHUB_STEP_SUMMARY
          echo "**Dry Run:** ${{ github.event.inputs.dry_run || 'false' }}" >> $GITHUB_STEP_SUMMARY

  cleanup-neurolink:
    name: Cleanup NeuroLink Images
    runs-on: ubuntu-latest
    if: github.event.inputs.service == 'all' || github.event.inputs.service == 'neurolink' || github.event_name == 'schedule'
    permissions:
      packages: write
      contents: read

    steps:
      - name: Delete old untagged images
        uses: actions/delete-package-versions@v5
        with:
          package-name: 'tsh-erp-neurolink'
          package-type: 'container'
          min-versions-to-keep: ${{ env.KEEP_LAST_N }}
          delete-only-untagged-versions: 'true'
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete old versions (keep last N and recent)
        uses: dataaxiom/ghcr-cleanup-action@v1
        with:
          package: tsh-erp-neurolink
          token: ${{ secrets.GITHUB_TOKEN }}
          owner: ${{ github.repository_owner }}
          keep-n-tagged: ${{ env.KEEP_LAST_N }}
          older-than: ${{ env.RETENTION_DAYS }} days
          exclude-tags: latest,production,staging,v*.*.*
          dry-run: ${{ github.event.inputs.dry_run || 'false' }}

      - name: Report cleanup summary
        run: |
          echo "## üßπ Cleanup Summary - NeuroLink Service" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Service:** tsh-erp-neurolink" >> $GITHUB_STEP_SUMMARY
          echo "**Retention:** ${{ env.RETENTION_DAYS }} days" >> $GITHUB_STEP_SUMMARY
          echo "**Versions Kept:** Last ${{ env.KEEP_LAST_N }}" >> $GITHUB_STEP_SUMMARY
          echo "**Protected Tags:** latest, production, staging, v*.*.*" >> $GITHUB_STEP_SUMMARY
          echo "**Dry Run:** ${{ github.event.inputs.dry_run || 'false' }}" >> $GITHUB_STEP_SUMMARY

  cleanup-tds-admin:
    name: Cleanup TDS Admin Dashboard Images
    runs-on: ubuntu-latest
    if: github.event.inputs.service == 'all' || github.event.inputs.service == 'tds-admin' || github.event_name == 'schedule'
    permissions:
      packages: write
      contents: read

    steps:
      - name: Delete old untagged images
        uses: actions/delete-package-versions@v5
        with:
          package-name: 'tsh-erp-tds-admin'
          package-type: 'container'
          min-versions-to-keep: ${{ env.KEEP_LAST_N }}
          delete-only-untagged-versions: 'true'
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete old versions (keep last N and recent)
        uses: dataaxiom/ghcr-cleanup-action@v1
        with:
          package: tsh-erp-tds-admin
          token: ${{ secrets.GITHUB_TOKEN }}
          owner: ${{ github.repository_owner }}
          keep-n-tagged: ${{ env.KEEP_LAST_N }}
          older-than: ${{ env.RETENTION_DAYS }} days
          exclude-tags: latest,production,staging,v*.*.*
          dry-run: ${{ github.event.inputs.dry_run || 'false' }}

      - name: Report cleanup summary
        run: |
          echo "## üßπ Cleanup Summary - TDS Admin Service" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Service:** tsh-erp-tds-admin" >> $GITHUB_STEP_SUMMARY
          echo "**Retention:** ${{ env.RETENTION_DAYS }} days" >> $GITHUB_STEP_SUMMARY
          echo "**Versions Kept:** Last ${{ env.KEEP_LAST_N }}" >> $GITHUB_STEP_SUMMARY
          echo "**Protected Tags:** latest, production, staging, v*.*.*" >> $GITHUB_STEP_SUMMARY
          echo "**Dry Run:** ${{ github.event.inputs.dry_run || 'false' }}" >> $GITHUB_STEP_SUMMARY

  notify-cleanup:
    name: Send Cleanup Notification
    runs-on: ubuntu-latest
    needs: [cleanup-app, cleanup-neurolink, cleanup-tds-admin]
    if: always()

    steps:
      - name: Calculate storage saved (estimate)
        id: calc
        run: |
          # Rough estimate: each image ~500MB, assume 50% deleted
          SERVICES_CLEANED=3
          AVG_IMAGE_SIZE_MB=500
          ESTIMATED_DELETED=15  # Conservative estimate
          STORAGE_SAVED=$((ESTIMATED_DELETED * AVG_IMAGE_SIZE_MB))

          echo "storage_saved_mb=$STORAGE_SAVED" >> $GITHUB_OUTPUT
          echo "services_cleaned=$SERVICES_CLEANED" >> $GITHUB_OUTPUT

      - name: Send Telegram notification
        if: ${{ secrets.TELEGRAM_BOT_TOKEN != '' && secrets.TELEGRAM_CHAT_ID != '' }}
        run: |
          MESSAGE="üßπ *GHCR Cleanup Complete*

üì¶ *Services Cleaned:* ${{ steps.calc.outputs.services_cleaned }}
üíæ *Estimated Storage Saved:* ~${{ steps.calc.outputs.storage_saved_mb }}MB
üìÖ *Retention Policy:* ${{ env.RETENTION_DAYS }} days
üî¢ *Versions Kept:* Last ${{ env.KEEP_LAST_N }} per service
üè∑Ô∏è *Protected Tags:* latest, production, staging, v*.*.*

‚úÖ *Status:* Cleanup completed successfully
üîó *Details:* ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="$MESSAGE" \
            -d parse_mode="Markdown" \
            -d disable_web_page_preview=true

      - name: Send email notification (optional)
        if: ${{ secrets.EMAIL_SMTP_HOST != '' }}
        continue-on-error: true
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.EMAIL_SMTP_HOST }}
          server_port: 465
          username: ${{ secrets.EMAIL_SMTP_USER }}
          password: ${{ secrets.EMAIL_SMTP_PASSWORD }}
          subject: "TSH ERP - GHCR Cleanup Report"
          to: devops@tsh.sale
          from: github-actions@tsh.sale
          body: |
            GHCR Cleanup completed successfully.

            Services cleaned: ${{ steps.calc.outputs.services_cleaned }}
            Estimated storage saved: ~${{ steps.calc.outputs.storage_saved_mb }}MB
            Retention policy: ${{ env.RETENTION_DAYS }} days
            Versions kept: Last ${{ env.KEEP_LAST_N }} per service

            Protected tags: latest, production, staging, v*.*.*

            View details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
