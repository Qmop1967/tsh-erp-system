name: ğŸ§  Intelligent Staging CI/CD with Auto-Healing

# NOTE: Deployment to staging is currently DISABLED (line 725)
# Enable it after VPS is properly configured with /opt/tsh_erp directory
# To enable: Change "if: false" to "if: github.ref == 'refs/heads/develop' && github.event_name == 'push'"

on:
  push:
    branches:
      - develop
  pull_request:
    branches:
      - develop

env:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "18"
  FLUTTER_VERSION: "3.35.5"

jobs:
  # ============================================================================
  # STAGE 1: CODE INTEGRITY & QUALITY CHECKS
  # ============================================================================
  code-quality:
    name: ğŸ“‹ Code Quality & Integrity
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy black bandit safety
          pip install -r config/requirements.txt || pip install -r requirements.txt || true

      - name: ğŸ” Python Linting (ruff)
        run: |
          echo "ğŸ” Checking Python code style..."
          ruff check . --output-format=github || echo "âš ï¸ Linting issues found"
        continue-on-error: true

      - name: ğŸ”’ Type Checking (mypy)
        run: |
          echo "ğŸ”’ Checking type annotations..."
          mypy app/ backend/ tds_core/ --ignore-missing-imports --no-strict-optional || echo "âš ï¸ Type issues found"
        continue-on-error: true

      - name: âš« Code Formatting Check (black)
        run: |
          echo "âš« Checking code formatting..."
          black --check app/ backend/ tds_core/ || echo "âš ï¸ Formatting issues found"
        continue-on-error: true

      - name: ğŸ” Security Scan (bandit)
        run: |
          echo "ğŸ” Scanning for security vulnerabilities..."
          bandit -r app/ backend/ tds_core/ -f json -o bandit-report.json || true
          bandit -r app/ backend/ tds_core/ -f screen || echo "âš ï¸ Security issues found"
        continue-on-error: true

      - name: ğŸ“Š Dependency Vulnerability Check
        run: |
          echo "ğŸ“Š Checking dependencies for known vulnerabilities..."
          safety check --file=config/requirements.txt --output=text || echo "âš ï¸ Vulnerable dependencies found"
        continue-on-error: true

      - name: ğŸ“¤ Upload Security Reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            bandit-report.json
          retention-days: 30

  # ============================================================================
  # STAGE 2: DATABASE SCHEMA & MIGRATIONS
  # ============================================================================
  database-validation:
    name: ğŸ—„ï¸ Database Schema Validation
    runs-on: ubuntu-latest
    needs: code-quality

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: tsh_erp_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: |
          pip install -r config/requirements.txt || pip install -r requirements.txt || true
          pip install alembic psycopg2-binary sqlalchemy

      - name: ğŸ” Check Migration Status
        run: |
          echo "ğŸ” Checking database migrations..."
          cd app || cd backend || true
          if [ -d "alembic" ]; then
            alembic current
            alembic upgrade head --sql > migration_preview.sql
            cat migration_preview.sql
            echo "âœ… Migrations are ready"
          else
            echo "âš ï¸ No alembic directory found"
          fi
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/tsh_erp_test
        continue-on-error: true

      - name: ğŸ—ƒï¸ Verify Schema Integrity
        run: |
          echo "ğŸ—ƒï¸ Verifying database schema..."
          psql $DATABASE_URL -c "\dt" || echo "âš ï¸ Could not verify schema"
          psql $DATABASE_URL -c "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public';" || true
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/tsh_erp_test
        continue-on-error: true

  # ============================================================================
  # STAGE 3: MODULE INTEGRITY & API TESTS
  # ============================================================================
  api-integration-tests:
    name: ğŸ”Œ API & Integration Tests
    runs-on: ubuntu-latest
    needs: database-validation

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: |
          pip install -r config/requirements.txt || pip install -r requirements.txt || true
          pip install pytest pytest-asyncio httpx

      - name: ğŸ§ª Run Unit Tests
        run: |
          echo "ğŸ§ª Running unit tests..."
          pytest tests/ -v --tb=short || echo "âš ï¸ Some tests failed"
        continue-on-error: true

      - name: ğŸ”Œ Test API Endpoints
        run: |
          echo "ğŸ”Œ Testing API endpoints..."
          python -c "
          import httpx
          import asyncio

          async def test_api():
              # Test health endpoint
              try:
                  async with httpx.AsyncClient() as client:
                      response = await client.get('http://localhost:8000/health', timeout=5.0)
                      print(f'âœ… Health check: {response.status_code}')
              except Exception as e:
                  print(f'âš ï¸ API test: {e}')

          asyncio.run(test_api())
          " || echo "âš ï¸ API tests incomplete"
        continue-on-error: true

  # ============================================================================
  # STAGE 4: ZOHO DATA CONSISTENCY CHECK
  # ============================================================================
  zoho-consistency-check:
    name: ğŸ”„ Zoho Data Consistency Verification
    runs-on: ubuntu-latest
    needs: api-integration-tests

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: |
          pip install requests psycopg2-binary python-dotenv

      - name: ğŸ”„ Compare Zoho vs TSH ERP Data
        run: |
          python3 << 'PYTHON_SCRIPT'
          import os
          import requests
          import psycopg2
          from datetime import datetime

          print("=" * 60)
          print("ğŸ”„ ZOHO DATA CONSISTENCY CHECK")
          print("=" * 60)

          # Zoho API Configuration
          ZOHO_ORG_ID = "${{ secrets.ZOHO_ORG_ID }}"
          ZOHO_TOKEN = "${{ secrets.ZOHO_ACCESS_TOKEN }}"

          # Database Configuration (Staging)
          DB_URL = "${{ secrets.STAGING_DB_URL }}"

          report = []
          report.append(f"\nğŸ“… Report Generated: {datetime.now().isoformat()}\n")
          report.append("=" * 60 + "\n")

          # Check 1: Contacts/Customers Count
          try:
              print("\nğŸ“Š Checking Contacts...")

              # Zoho API call
              headers = {"Authorization": f"Zoho-oauthtoken {ZOHO_TOKEN}"}
              zoho_response = requests.get(
                  f"https://www.zohoapis.com/books/v3/contacts?organization_id={ZOHO_ORG_ID}",
                  headers=headers,
                  timeout=10
              )

              if zoho_response.status_code == 200:
                  zoho_count = len(zoho_response.json().get('contacts', []))
                  print(f"  Zoho Contacts: {zoho_count}")
                  report.append(f"âœ… Zoho Contacts: {zoho_count}\n")
              else:
                  print(f"  âš ï¸ Zoho API Error: {zoho_response.status_code}")
                  report.append(f"âš ï¸ Zoho API Error: {zoho_response.status_code}\n")
                  zoho_count = 0

              # Database query
              try:
                  conn = psycopg2.connect(DB_URL)
                  cur = conn.cursor()
                  cur.execute("SELECT COUNT(*) FROM customers WHERE is_active = true;")
                  erp_count = cur.fetchone()[0]
                  print(f"  TSH ERP Customers: {erp_count}")
                  report.append(f"âœ… TSH ERP Customers: {erp_count}\n")

                  # Compare
                  diff = abs(zoho_count - erp_count)
                  diff_pct = (diff / max(zoho_count, erp_count) * 100) if max(zoho_count, erp_count) > 0 else 0

                  if diff_pct > 10:
                      print(f"  âŒ Large difference: {diff} records ({diff_pct:.1f}%)")
                      report.append(f"âŒ ALERT: Difference of {diff} records ({diff_pct:.1f}%)\n")
                  else:
                      print(f"  âœ… Acceptable difference: {diff} records ({diff_pct:.1f}%)")
                      report.append(f"âœ… Acceptable: {diff} records difference\n")

                  cur.close()
                  conn.close()
              except Exception as e:
                  print(f"  âš ï¸ Database Error: {e}")
                  report.append(f"âš ï¸ Database Error: {e}\n")

          except Exception as e:
              print(f"  âš ï¸ Check Failed: {e}")
              report.append(f"âš ï¸ Contacts Check Failed: {e}\n")

          # Check 2: Products/Items Count
          try:
              print("\nğŸ“¦ Checking Products...")

              # Zoho API call
              zoho_response = requests.get(
                  f"https://www.zohoapis.com/books/v3/items?organization_id={ZOHO_ORG_ID}",
                  headers=headers,
                  timeout=10
              )

              if zoho_response.status_code == 200:
                  zoho_count = len(zoho_response.json().get('items', []))
                  print(f"  Zoho Items: {zoho_count}")
                  report.append(f"âœ… Zoho Items: {zoho_count}\n")
              else:
                  print(f"  âš ï¸ Zoho API Error: {zoho_response.status_code}")
                  report.append(f"âš ï¸ Zoho API Error: {zoho_response.status_code}\n")
                  zoho_count = 0

              # Database query
              try:
                  conn = psycopg2.connect(DB_URL)
                  cur = conn.cursor()
                  cur.execute("SELECT COUNT(*) FROM products WHERE is_active = true;")
                  erp_count = cur.fetchone()[0]
                  print(f"  TSH ERP Products: {erp_count}")
                  report.append(f"âœ… TSH ERP Products: {erp_count}\n")

                  # Compare
                  diff = abs(zoho_count - erp_count)
                  diff_pct = (diff / max(zoho_count, erp_count) * 100) if max(zoho_count, erp_count) > 0 else 0

                  if diff_pct > 10:
                      print(f"  âŒ Large difference: {diff} records ({diff_pct:.1f}%)")
                      report.append(f"âŒ ALERT: Difference of {diff} records ({diff_pct:.1f}%)\n")
                  else:
                      print(f"  âœ… Acceptable difference: {diff} records ({diff_pct:.1f}%)")
                      report.append(f"âœ… Acceptable: {diff} records difference\n")

                  cur.close()
                  conn.close()
              except Exception as e:
                  print(f"  âš ï¸ Database Error: {e}")
                  report.append(f"âš ï¸ Database Error: {e}\n")

          except Exception as e:
              print(f"  âš ï¸ Check Failed: {e}")
              report.append(f"âš ï¸ Products Check Failed: {e}\n")

          # Save report
          report.append("\n" + "=" * 60 + "\n")
          report.append("ğŸ“Š END OF CONSISTENCY CHECK\n")

          with open("zoho_sync_report.txt", "w") as f:
              f.writelines(report)

          print("\nâœ… Report saved to: zoho_sync_report.txt")
          PYTHON_SCRIPT
        continue-on-error: true

      - name: ğŸ“¤ Upload Zoho Sync Report
        uses: actions/upload-artifact@v4
        with:
          name: zoho-consistency-report
          path: zoho_sync_report.txt
          retention-days: 30

  # ============================================================================
  # STAGE 5: ZOHO TIMESTAMP VERIFICATION
  # ============================================================================
  zoho-timestamp-check:
    name: â° Zoho Timestamp Consistency
    runs-on: ubuntu-latest
    needs: zoho-consistency-check

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: pip install requests psycopg2-binary python-dateutil

      - name: â° Verify Last Update Timestamps
        run: |
          python3 << 'PYTHON_SCRIPT'
          import requests
          import psycopg2
          from datetime import datetime, timedelta
          from dateutil import parser

          print("=" * 60)
          print("â° ZOHO TIMESTAMP CONSISTENCY CHECK")
          print("=" * 60)

          ZOHO_ORG_ID = "${{ secrets.ZOHO_ORG_ID }}"
          ZOHO_TOKEN = "${{ secrets.ZOHO_ACCESS_TOKEN }}"
          DB_URL = "${{ secrets.STAGING_DB_URL }}"

          headers = {"Authorization": f"Zoho-oauthtoken {ZOHO_TOKEN}"}
          report = []
          report.append(f"\nğŸ“… Timestamp Check: {datetime.now().isoformat()}\n")
          report.append("=" * 60 + "\n")

          # Check last modified contact in Zoho
          try:
              print("\nğŸ• Checking last modified contact...")
              response = requests.get(
                  f"https://www.zohoapis.com/books/v3/contacts?organization_id={ZOHO_ORG_ID}&sort_column=last_modified_time&sort_order=D&per_page=1",
                  headers=headers,
                  timeout=10
              )

              if response.status_code == 200:
                  contacts = response.json().get('contacts', [])
                  if contacts:
                      zoho_last_modified = parser.parse(contacts[0].get('last_modified_time'))
                      print(f"  Zoho Last Modified: {zoho_last_modified}")
                      report.append(f"âœ… Zoho Last Contact Update: {zoho_last_modified}\n")

                      # Check ERP last modified
                      conn = psycopg2.connect(DB_URL)
                      cur = conn.cursor()
                      cur.execute("SELECT MAX(updated_at) FROM customers;")
                      erp_last_modified = cur.fetchone()[0]
                      print(f"  ERP Last Modified: {erp_last_modified}")
                      report.append(f"âœ… ERP Last Customer Update: {erp_last_modified}\n")

                      # Compare time difference
                      if erp_last_modified:
                          time_diff = abs((zoho_last_modified - erp_last_modified.replace(tzinfo=zoho_last_modified.tzinfo)).total_seconds())
                          hours_diff = time_diff / 3600

                          if hours_diff > 24:
                              print(f"  âŒ Sync delay: {hours_diff:.1f} hours")
                              report.append(f"âŒ ALERT: Sync delay of {hours_diff:.1f} hours\n")
                          else:
                              print(f"  âœ… Sync is current: {hours_diff:.1f} hours difference")
                              report.append(f"âœ… Sync OK: {hours_diff:.1f} hours difference\n")

                      cur.close()
                      conn.close()
          except Exception as e:
              print(f"  âš ï¸ Timestamp check failed: {e}")
              report.append(f"âš ï¸ Timestamp Check Error: {e}\n")

          # Save report
          with open("zoho_timestamp_report.txt", "w") as f:
              f.writelines(report)

          print("\nâœ… Timestamp report saved")
          PYTHON_SCRIPT
        continue-on-error: true

      - name: ğŸ“¤ Upload Timestamp Report
        uses: actions/upload-artifact@v4
        with:
          name: zoho-timestamp-report
          path: zoho_timestamp_report.txt
          retention-days: 30

  # ============================================================================
  # STAGE 6: ZOHO WEBHOOK HEALTH CHECK
  # ============================================================================
  zoho-webhook-health:
    name: ğŸ”” Zoho Webhook Health Check
    runs-on: ubuntu-latest
    needs: zoho-timestamp-check

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: pip install requests

      - name: ğŸ”” Test Webhook Endpoints
        run: |
          python3 << 'PYTHON_SCRIPT'
          import requests
          import json
          from datetime import datetime

          print("=" * 60)
          print("ğŸ”” ZOHO WEBHOOK HEALTH CHECK")
          print("=" * 60)

          WEBHOOK_BASE = "${{ secrets.WEBHOOK_BASE_URL }}" or "https://erp.tsh.sale/api/webhooks"

          webhooks = [
              {"name": "Contact Created", "path": "/zoho/contact/created"},
              {"name": "Contact Updated", "path": "/zoho/contact/updated"},
              {"name": "Invoice Created", "path": "/zoho/invoice/created"},
              {"name": "Invoice Updated", "path": "/zoho/invoice/updated"},
              {"name": "Item Created", "path": "/zoho/item/created"},
              {"name": "Item Updated", "path": "/zoho/item/updated"},
              {"name": "Salesorder Created", "path": "/zoho/salesorder/created"},
              {"name": "Salesorder Updated", "path": "/zoho/salesorder/updated"},
          ]

          report = []
          report.append(f"\nğŸ“… Webhook Health Check: {datetime.now().isoformat()}\n")
          report.append("=" * 60 + "\n\n")

          test_payload = {
              "event": "test",
              "data": {"test": True}
          }

          passed = 0
          failed = 0

          for webhook in webhooks:
              url = f"{WEBHOOK_BASE}{webhook['path']}"
              print(f"\nğŸ”” Testing: {webhook['name']}")
              print(f"   URL: {url}")

              try:
                  response = requests.post(
                      url,
                      json=test_payload,
                      timeout=10,
                      headers={"Content-Type": "application/json"}
                  )

                  if response.status_code in [200, 201, 202]:
                      print(f"   âœ… Status: {response.status_code}")
                      report.append(f"âœ… {webhook['name']}: {url} (HTTP {response.status_code})\n")
                      passed += 1
                  else:
                      print(f"   âš ï¸ Status: {response.status_code}")
                      report.append(f"âš ï¸ {webhook['name']}: {url} (HTTP {response.status_code})\n")
                      failed += 1

              except requests.exceptions.Timeout:
                  print(f"   âŒ Timeout")
                  report.append(f"âŒ {webhook['name']}: {url} (TIMEOUT)\n")
                  failed += 1
              except requests.exceptions.ConnectionError:
                  print(f"   âŒ Connection Error")
                  report.append(f"âŒ {webhook['name']}: {url} (CONNECTION ERROR)\n")
                  failed += 1
              except Exception as e:
                  print(f"   âŒ Error: {e}")
                  report.append(f"âŒ {webhook['name']}: {url} (ERROR: {e})\n")
                  failed += 1

          # Summary
          report.append(f"\n{'=' * 60}\n")
          report.append(f"ğŸ“Š SUMMARY\n")
          report.append(f"   âœ… Passed: {passed}/{len(webhooks)}\n")
          report.append(f"   âŒ Failed: {failed}/{len(webhooks)}\n")
          report.append(f"{'=' * 60}\n")

          print(f"\nğŸ“Š Summary: {passed} passed, {failed} failed out of {len(webhooks)} webhooks")

          # Save report
          with open("zoho_webhook_report.txt", "w") as f:
              f.writelines(report)

          print("\nâœ… Webhook health report saved")
          PYTHON_SCRIPT
        continue-on-error: true

      - name: ğŸ“¤ Upload Webhook Health Report
        uses: actions/upload-artifact@v4
        with:
          name: zoho-webhook-report
          path: zoho_webhook_report.txt
          retention-days: 30

  # ============================================================================
  # STAGE 7: AUTO-HEALING SUGGESTION GENERATOR
  # ============================================================================
  auto-healing-analysis:
    name: ğŸ¤– Auto-Healing Analysis & Suggestions
    runs-on: ubuntu-latest
    needs: [zoho-consistency-check, zoho-timestamp-check, zoho-webhook-health]

    steps:
      - name: ğŸ“¥ Download All Reports
        uses: actions/download-artifact@v4
        with:
          path: reports/

      - name: ğŸ§  Analyze Issues & Generate Healing Suggestions
        run: |
          python3 << 'PYTHON_SCRIPT'
          import os
          import re
          from datetime import datetime

          print("=" * 60)
          print("ğŸ¤– AUTO-HEALING ANALYSIS")
          print("=" * 60)

          suggestions = []
          suggestions.append(f"\nğŸ¤– Auto-Healing Suggestions Generated: {datetime.now().isoformat()}\n")
          suggestions.append("=" * 60 + "\n\n")

          issues_found = []

          # Analyze Zoho Sync Report
          try:
              with open("reports/zoho-consistency-report/zoho_sync_report.txt", "r") as f:
                  content = f.read()
                  print("\nğŸ“Š Analyzing Zoho Sync Report...")

                  if "âŒ ALERT" in content:
                      issues_found.append("zoho_sync_mismatch")
                      suggestions.append("ğŸ”§ ISSUE DETECTED: Zoho Data Sync Mismatch\n")
                      suggestions.append("   ğŸ“‹ Diagnosis: Significant difference between Zoho and TSH ERP data counts\n")
                      suggestions.append("   ğŸ¯ Possible Cause: Sync process not running or webhook failures\n")
                      suggestions.append("   ğŸ’¡ Suggested Fix:\n")
                      suggestions.append("      1. Check TDS Core sync worker status: systemctl status tds-core-worker\n")
                      suggestions.append("      2. Review sync queue for stuck items: SELECT * FROM tds_sync_queue WHERE status='failed'\n")
                      suggestions.append("      3. Trigger manual resync: python scripts/resync_zoho.py --entity=all\n")
                      suggestions.append("      4. Check webhook registration: python scripts/verify_webhooks.py\n\n")
          except FileNotFoundError:
              print("   âš ï¸ Sync report not found")

          # Analyze Timestamp Report
          try:
              with open("reports/zoho-timestamp-report/zoho_timestamp_report.txt", "r") as f:
                  content = f.read()
                  print("\nâ° Analyzing Timestamp Report...")

                  if "âŒ ALERT" in content:
                      issues_found.append("sync_delay")
                      suggestions.append("ğŸ”§ ISSUE DETECTED: Sync Timestamp Delay\n")
                      suggestions.append("   ğŸ“‹ Diagnosis: Last sync timestamp shows significant delay (>24 hours)\n")
                      suggestions.append("   ğŸ¯ Possible Cause: Worker service stopped or webhook not received\n")
                      suggestions.append("   ğŸ’¡ Suggested Fix:\n")
                      suggestions.append("      1. Restart sync worker: sudo systemctl restart tds-core-worker\n")
                      suggestions.append("      2. Check worker logs: journalctl -u tds-core-worker -n 100\n")
                      suggestions.append("      3. Verify webhook delivery: Check Zoho Webhooks settings\n")
                      suggestions.append("      4. Manual trigger for recent changes: python scripts/sync_recent.py --hours=24\n\n")
          except FileNotFoundError:
              print("   âš ï¸ Timestamp report not found")

          # Analyze Webhook Report
          try:
              with open("reports/zoho-webhook-report/zoho_webhook_report.txt", "r") as f:
                  content = f.read()
                  print("\nğŸ”” Analyzing Webhook Report...")

                  failed_webhooks = re.findall(r"âŒ (.+?):", content)
                  if failed_webhooks:
                      issues_found.append("webhook_failures")
                      suggestions.append(f"ğŸ”§ ISSUE DETECTED: {len(failed_webhooks)} Webhook(s) Failing\n")
                      suggestions.append(f"   ğŸ“‹ Failed Webhooks: {', '.join(failed_webhooks)}\n")
                      suggestions.append("   ğŸ¯ Possible Cause: SSL certificate issue, firewall, or endpoint error\n")
                      suggestions.append("   ğŸ’¡ Suggested Fix:\n")
                      suggestions.append("      1. Check SSL certificate: curl -v https://erp.tsh.sale\n")
                      suggestions.append("      2. Verify Nginx config: sudo nginx -t\n")
                      suggestions.append("      3. Check backend service: systemctl status tsh-erp\n")
                      suggestions.append("      4. Re-register webhooks: python scripts/register_webhooks.py\n")
                      suggestions.append("      5. Check firewall: sudo ufw status\n\n")
          except FileNotFoundError:
              print("   âš ï¸ Webhook report not found")

          # Final Summary
          if not issues_found:
              suggestions.append("âœ… NO CRITICAL ISSUES DETECTED\n")
              suggestions.append("   All systems appear to be functioning normally.\n")
              suggestions.append("   No healing actions required at this time.\n\n")
              print("\nâœ… No critical issues detected!")
          else:
              suggestions.append(f"ğŸ“Š SUMMARY: {len(issues_found)} issue(s) detected\n")
              suggestions.append(f"   Issues: {', '.join(issues_found)}\n\n")
              suggestions.append("ğŸ¯ RECOMMENDED ACTIONS:\n")
              suggestions.append("   1. Review all suggestions above\n")
              suggestions.append("   2. Execute healing commands on VPS\n")
              suggestions.append("   3. Monitor system for 15 minutes after healing\n")
              suggestions.append("   4. Re-run this workflow to verify fixes\n\n")
              print(f"\nâš ï¸ {len(issues_found)} issues detected - suggestions generated")

          # Save suggestions
          suggestions.append("=" * 60 + "\n")
          suggestions.append("ğŸ“ For Claude Code Agent Integration:\n")
          suggestions.append("   scp auto_healing_suggestions.txt root@167.71.39.50:/tmp/tsh_autoheal/\n")
          suggestions.append("   ssh root@167.71.39.50 'claude-code execute /tmp/tsh_autoheal/auto_healing_suggestions.txt'\n")

          with open("auto_healing_suggestions.txt", "w") as f:
              f.writelines(suggestions)

          print("\nâœ… Auto-healing suggestions generated")
          print("\nğŸ“„ Review the file: auto_healing_suggestions.txt")
          PYTHON_SCRIPT

      - name: ğŸ“¤ Upload Auto-Healing Suggestions
        uses: actions/upload-artifact@v4
        with:
          name: auto-healing-suggestions
          path: auto_healing_suggestions.txt
          retention-days: 90

      - name: ğŸ“¢ Create GitHub Issue for Critical Issues
        if: contains(needs.*.result, 'failure')
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            let body = '## ğŸš¨ Auto-Healing Report: Issues Detected\n\n';

            try {
              const suggestions = fs.readFileSync('auto_healing_suggestions.txt', 'utf8');
              body += '```\n' + suggestions + '\n```\n';
            } catch (e) {
              body += 'Could not load auto-healing suggestions.\n';
            }

            body += '\n---\n';
            body += `**Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸ¤– Auto-Healing: Issues Detected in Staging',
              body: body,
              labels: ['auto-healing', 'staging', 'needs-attention']
            });

  # ============================================================================
  # STAGE 8: DEPLOY TO STAGING (IF ALL CHECKS PASS)
  # ============================================================================
  deploy-to-staging:
    name: ğŸš€ Deploy to Staging Server
    runs-on: ubuntu-latest
    needs: [code-quality, database-validation, api-integration-tests, auto-healing-analysis]
    if: false  # Disabled - Enable after VPS setup complete

    steps:
      - name: ğŸ¯ Deploy to Staging via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: ${{ secrets.PROD_SSH_PORT || 22 }}
          script_stop: true
          script: |
            echo "ğŸš€ Starting Staging Deployment..."

            cd /opt/tsh_erp
            git fetch origin
            git checkout develop
            git pull origin develop

            # Activate virtual environment
            source venv/bin/activate || source .venv/bin/activate

            # Install/update dependencies
            pip install -q -r config/requirements.txt

            # Run migrations
            if [ -d "alembic" ]; then
              alembic upgrade head
            fi

            # Restart staging service (port 8002)
            sudo systemctl restart tsh_erp-green || sudo systemctl restart tsh-erp-staging

            # Wait and verify
            sleep 5
            curl -f http://127.0.0.1:8002/health || curl -f http://127.0.0.1:8001/health

            echo "âœ… Staging deployment completed!"

      - name: âœ… Deployment Success Notification
        if: success()
        run: |
          echo "âœ… Staging deployment completed successfully!"
          echo "ğŸ”— Check staging at: https://staging.erp.tsh.sale"

      - name: âŒ Deployment Failure Notification
        if: failure()
        run: |
          echo "âŒ Staging deployment failed!"
          echo "ğŸ” Check logs for details"
